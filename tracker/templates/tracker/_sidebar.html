{# tracker/templates/tracker/_sidebar.html #}
<div class="max-w-60 min-w-[200px] flex-none">
  <!-- Main Dashboard Button -->
  <div class="mb-5">
    <a href="{% url 'dashboard' %}" class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg py-3 text-center text-lg transition-colors">ğŸ  Dashboard</a>
  </div>

  <!-- Ingest New Messages - Prominent Action -->
  <div class="mb-5 relative">
    <a href="{% url 'reingest_admin' %}" class="block w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg py-3 text-center transition-colors">ğŸ“¥ Ingest New Messages</a>
    <div id="ingestion-indicator" class="hidden absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-4 h-4 animate-pulse">
      <span class="block w-full h-full rounded-full bg-red-500 animate-ping"></span>
    </div>
  </div>

  <!-- Upcoming Interviews at the top -->
  <div class="bg-white p-4 rounded-lg mb-4 shadow-sm">
    <h2 class="text-sm font-semibold mb-3 text-gray-800">ğŸ—“ï¸ Upcoming Interviews</h2>
    <ul class="list-none pl-0 m-0">
      {% for interview in upcoming_interviews %}
        <li class="py-2 text-xs text-gray-600">{{ interview.company.name }} â€” {{ interview.interview_date|date:"Y-m-d" }}</li>
      {% empty %}
        <li class="py-2 text-xs text-gray-600">No upcoming interviews</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Summary Stats -->
  <div class="bg-white p-4 rounded-lg mb-4 shadow-sm">
    <h2 class="text-sm font-semibold mb-3 text-gray-800">ğŸ“Š Summary</h2>
    <ul class="list-none pl-0 m-0">
      <li class="flex justify-between py-2 text-xs text-gray-600 border-b border-gray-100">Total Companies: <span>{{ companies }}</span></li>
      <li class="flex justify-between py-2 text-xs text-gray-600 border-b border-gray-100">Total Applications: <span>{{ applications_count|default:applications }}</span></li>
      <li class="flex justify-between py-2 text-xs text-gray-600 border-b border-gray-100">Applications This Week: <span>{{ applications_week }}</span></li>
      <li class="flex justify-between py-2 text-xs text-gray-600 border-b border-gray-100">Rejections This Week: <span>{{ rejections_week }}</span></li>
      <li class="flex justify-between py-2 text-xs text-gray-600 border-b border-gray-100">Interviews This Week: <span>{{ interviews_week }}</span></li>
      <li class="flex justify-between py-2 text-xs text-gray-600">Companies Ghosted: <span>{{ ghosted_count }}</span></li>
    </ul>
  </div>

  <!-- Ingestion Stats -->
  <div class="bg-white p-4 rounded-lg mb-4 shadow-sm">
    <h2 class="text-sm font-semibold mb-3 text-gray-800">Ingestion Stats (Today)</h2>
    {% if latest_stats %}
      <ul class="list-none pl-0 m-0">
        {% if latest_stats.total_inserted == 0 %}
        <div class="bg-red-50 p-2 rounded mt-2 text-xs text-red-800">
          âš ï¸ No new messages ingested today.
        </div>
        {% endif %}
        <li class="flex justify-between py-2 text-xs text-gray-600 border-b border-gray-100">ğŸ“¥ Fetched: <strong>{{ latest_stats.total_fetched }}</strong></li>
        <li class="flex justify-between py-2 text-xs text-gray-600 border-b border-gray-100">âœ… Inserted: <strong>{{ latest_stats.total_inserted }}</strong></li>
        <li class="flex justify-between py-2 text-xs text-gray-600 border-b border-gray-100">ğŸš« Ignored: <strong>{{ latest_stats.total_ignored }}</strong></li>
        <li class="flex justify-between py-2 text-xs text-gray-600 border-b border-gray-100">â­ï¸ Skipped: <strong>{{ latest_stats.total_skipped }}</strong></li>
        <li class="flex justify-between py-2 text-xs text-gray-600">ğŸ“Š Success Rate: 
          <strong>
            {{ latest_stats.total_inserted|floatformat:2 }} /
            {{ latest_stats.total_inserted|add:latest_stats.total_ignored|add:latest_stats.total_skipped }}
          </strong>
        </li>
      </ul>
      <p class="text-[0.7rem] text-gray-400 mt-2">Last updated: {{ latest_stats.date }}</p>
      <p class="text-[0.7rem] text-gray-400 mt-1">Last sync: {{ latest_stats.last_updated|date:"Y-m-d H:i" }}</p>
    {% else %}
      <p class="text-xs text-gray-500">No ingestion stats available yet.</p>
    {% endif %}
  </div>


  <!-- Quick Actions -->
  <div class="bg-white p-4 rounded-lg mb-4 shadow-sm">
    <h2 class="text-sm font-semibold mb-3 text-gray-800">âš™ï¸ Quick Actions</h2>
    <div class="flex flex-col gap-2">
      <select id="quickActionSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="if(this.value) window.location.href = this.value;">
        <option value="">-- Select Action --</option>
        <option value="{% url 'manual_entry' %}">ğŸ“ Manual Entry</option>
        <option value="/admin/tracker/message/upload-eml/">ğŸ“§ Upload .eml File</option>
        <option value="{% url 'label_messages' %}">ğŸ·ï¸ Label Messages</option>
        <option value="{% url 'label_companies' %}">ğŸ·ï¸ Label Companies</option>
        <option value="{% url 'metrics' %}">View Metrics</option>
        <option value="{% url 'company_threads' %}">Company Threads</option>
        <option value="{% url 'json_file_viewer' %}">JSON File Viewer</option>
        <option value="{% url 'configure_settings' %}">Configure Settings</option>
        <option value="{% url 'manage_domains' %}">ğŸŒ Domain Management</option>
        <option value="{% url 'label_rule_debugger' %}">Label Rule Debugger</option>
        <option value="{% url 'log_viewer' %}">Log Viewer</option>
        <option value="{% url 'retrain_model' %}">ğŸ¤– Retrain Model</option>
      </select>
    </div>
  </div>
</div>

<style>
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  @keyframes ping {
    75%, 100% {
      transform: scale(2);
      opacity: 0;
    }
  }
</style>

<script>
  // Poll ingestion status every 5 seconds
  function checkIngestionStatus() {
    fetch('/api/ingestion_status/')
      .then(response => response.json())
      .then(data => {
        const indicator = document.getElementById('ingestion-indicator');
        const statusText = document.getElementById('ingestion-status-text');
        
        if (data.is_running) {
          indicator.classList.remove('hidden');
          if (!statusText) {
            // Create status text if it doesn't exist
            const textDiv = document.createElement('div');
            textDiv.id = 'ingestion-status-text';
            textDiv.className = 'text-xs p-2 bg-amber-50 rounded-lg mb-2 text-center font-semibold text-amber-800';
            textDiv.textContent = 'âš¡ Ingestion in progress...';
            const sidebar = document.querySelector('.max-w-60') || document.querySelector('.sidebar');
            sidebar.insertBefore(textDiv, sidebar.firstChild);
          }
        } else {
          indicator.classList.add('hidden');
          if (statusText) {
            statusText.remove();
          }
        }
      })
      .catch(error => {
        console.error('Error checking ingestion status:', error);
      });
  }
  
  // Check immediately and then every 5 seconds
  checkIngestionStatus();
  setInterval(checkIngestionStatus, 5000);
</script>
