{# tracker/templates/tracker/_sidebar.html #}
<div class="sidebar" style="max-width: 240px; min-width: 200px; flex: 0 0 220px;">
  <!-- Main Dashboard Button -->
  <div style="margin-bottom:1.2rem;">
    <a href="{% url 'dashboard' %}" class="button" style="display:block; width:100%; background:#2563eb; color:white; font-weight:600; border-radius:6px; padding:0.7rem 0; text-align:center; font-size:1.1rem;">ğŸ  Dashboard</a>
  </div>

  <!-- Ingest New Messages - Prominent Action -->
  <div style="margin-bottom:1.2rem; position:relative;">
    <a href="{% url 'reingest_admin' %}" class="button" style="display:block; width:100%; background:#059669; color:white; font-weight:600; border-radius:6px; padding:0.7rem 0; text-align:center; font-size:1rem;">ğŸ“¥ Ingest New Messages</a>
    <div id="ingestion-indicator" style="display:none; position:absolute; top:-8px; right:-8px; background:#ef4444; color:white; border-radius:50%; width:16px; height:16px; animation:pulse 2s infinite;">
      <span style="display:block; width:100%; height:100%; border-radius:50%; background:#ef4444; animation:ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;"></span>
    </div>
  </div>

  <!-- Upcoming Interviews at the top -->
  <div class="card">
    <h2>ğŸ—“ï¸ Upcoming Interviews</h2>
    <ul>
      {% for interview in upcoming_interviews %}
        <li>{{ interview.company.name }} â€” {{ interview.interview_date|date:"Y-m-d" }}</li>
      {% empty %}
        <li>No upcoming interviews</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Summary Stats -->
  <div class="card">
    <h2>ğŸ“Š Summary</h2>
    <ul class="stats">
  <li>Total Companies: {{ companies }}</li>
  <li>Total Applications: {{ applications_count|default:applications }}</li>
      <li>Applications This Week: {{ applications_week }}</li>
      <li>Rejections This Week: {{ rejections_week }}</li>
      <li>Interviews This Week: {{ interviews_week }}</li>
      <li>Companies Ghosted: {{ ghosted_count }}</li>
    </ul>
  </div>

  <!-- Ingestion Stats -->
  <div class="card">
    <h2>Ingestion Stats (Today)</h2>
    {% if latest_stats %}
      <ul class="stats">
        {% if latest_stats.total_inserted == 0 %}
        <div style="background:#fee2e2; padding:0.5rem; border-radius:4px; margin-top:0.5rem; font-size:0.75rem;">
          âš ï¸ No new messages ingested today.
        </div>
        {% endif %}
        <li>ğŸ“¥ Fetched: <strong>{{ latest_stats.total_fetched }}</strong></li>
        <li>âœ… Inserted: <strong>{{ latest_stats.total_inserted }}</strong></li>
        <li>ğŸš« Ignored: <strong>{{ latest_stats.total_ignored }}</strong></li>
        <li>â­ï¸ Skipped: <strong>{{ latest_stats.total_skipped }}</strong></li>
        <li>ğŸ“Š Success Rate: 
          <strong>
            {{ latest_stats.total_inserted|floatformat:2 }} /
            {{ latest_stats.total_inserted|add:latest_stats.total_ignored|add:latest_stats.total_skipped }}
          </strong>
        </li>
      </ul>
      <p class="timestamp">Last updated: {{ latest_stats.date }}</p>
      <p class="timestamp">Last sync: {{ latest_stats.last_updated|date:"Y-m-d H:i" }}</p>
    {% else %}
      <p style="font-size:0.75rem;">No ingestion stats available yet.</p>
    {% endif %}
  </div>


  <!-- Quick Actions -->
  <div class="card">
    <h2>âš™ï¸ Quick Actions</h2>
    <div style="display:flex; flex-direction:column; gap:0.5rem;">
      <select id="quickActionSelect" style="width:100%; padding:0.6rem; border:1px solid #d1d5db; border-radius:6px; font-size:0.9rem; background:white;" onchange="if(this.value) window.location.href = this.value;">
        <option value="">-- Select Action --</option>
        <option value="{% url 'manual_entry' %}">ğŸ“ Manual Entry</option>
        <option value="/admin/tracker/message/upload-eml/">ğŸ“§ Upload .eml File</option>
        <option value="{% url 'label_messages' %}">ğŸ·ï¸ Label Messages</option>
        <option value="{% url 'label_companies' %}">ğŸ·ï¸ Label Companies</option>
        <option value="{% url 'metrics' %}">View Metrics</option>
        <option value="{% url 'company_threads' %}">Company Threads</option>
        <option value="{% url 'json_file_viewer' %}">JSON File Viewer</option>
        <option value="{% url 'configure_settings' %}">Configure Settings</option>
        <option value="{% url 'manage_domains' %}">ğŸŒ Domain Management</option>
        <option value="{% url 'label_rule_debugger' %}">Label Rule Debugger</option>
        <option value="{% url 'log_viewer' %}">Log Viewer</option>
        <option value="{% url 'retrain_model' %}">ğŸ¤– Retrain Model</option>
      </select>
    </div>
  </div>
</div>

<style>
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  @keyframes ping {
    75%, 100% {
      transform: scale(2);
      opacity: 0;
    }
  }
  #ingestion-status-text {
    font-size: 0.75rem;
    padding: 0.5rem;
    background: #fef3c7;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    text-align: center;
    font-weight: 600;
    color: #92400e;
  }
</style>

<script>
  // Poll ingestion status every 5 seconds
  function checkIngestionStatus() {
    fetch('/api/ingestion_status/')
      .then(response => response.json())
      .then(data => {
        const indicator = document.getElementById('ingestion-indicator');
        const statusText = document.getElementById('ingestion-status-text');
        
        if (data.is_running) {
          indicator.style.display = 'block';
          if (!statusText) {
            // Create status text if it doesn't exist
            const textDiv = document.createElement('div');
            textDiv.id = 'ingestion-status-text';
            textDiv.textContent = 'âš¡ Ingestion in progress...';
            document.querySelector('.sidebar').insertBefore(textDiv, document.querySelector('.sidebar').firstChild);
          }
        } else {
          indicator.style.display = 'none';
          if (statusText) {
            statusText.remove();
          }
        }
      })
      .catch(error => {
        console.error('Error checking ingestion status:', error);
      });
  }
  
  // Check immediately and then every 5 seconds
  checkIngestionStatus();
  setInterval(checkIngestionStatus, 5000);
</script>
