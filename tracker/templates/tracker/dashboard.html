{% extends "base.html" %}
{% block title %}Dashboard - GmailJobTracker{% endblock %}
{% block extra_head %}
  <style>
    h1 {
      color: #1f2937;
      margin-top: 0.5rem;
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
    }
    h2 {
      color: #1f2937;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    .charts-row {
      display: flex;
      gap: 1.5rem;
      margin-top: 1rem;
    }
    .chart-card {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      flex: 1 1 33%;
  min-width: 200px;
  max-width: 25%;
      transition: max-width 0.3s, min-width 0.3s;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .chart-card.expanded {
      max-width: 100%;
  min-width: 400px;
      z-index: 2;
    }
    .expand-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.3rem 0.7rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .expand-btn:hover {
      background: #1e40af;
    }
    canvas {
      width: 100% !important;
      height: 180px !important;
      max-width: 100%;
      margin-top: 0.5rem;
    }
    .date-filter-container {
      margin-top: 1rem;
      padding: 0.75rem;
      background: #f9fafb;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    .filter-wrapper {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .date-input-group {
      display: flex;
      gap: 0.4rem;
      align-items: center;
    }
    .date-input-group input[type="date"],
    select#quickRange {
      padding: 0.3rem 0.4rem;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 0.75rem;
      color: #111827;
      background: white;
      height: 1.85rem;
      line-height: 1.25;
      vertical-align: middle;
      box-sizing: border-box;
      margin: 0;
      display: inline-flex;
      align-items: center;
    }
    .date-input-group .sep { color: #6b7280; font-size: 0.75rem; }
    .reset-btn {
      background: #6b7280;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.3rem 0.6rem;
      font-size: 0.75rem;
      cursor: pointer;
      height: 1.85rem;
      line-height: 1.25;
      vertical-align: middle;
      box-sizing: border-box;
      margin: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .reset-btn:hover {
      background: #4b5563;
    }
    .copy-btn {
      background: #e5e7eb;
      color: #111827;
      border: none;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
  font-size: 0.7rem;
      margin-left: 0.5rem;
      cursor: pointer;
    }
    .copy-btn:hover { background: #d1d5db; }
    @media (max-width: 900px) {
      .charts-row { flex-direction: column; }
  .chart-card { max-width: 100%; min-width: 180px; }
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Company Filter (Full Width) -->
  <div style="display:flex; align-items:center; gap:1rem; margin-bottom: 1rem;">
    <label for="dashboard_company" style="font-size:0.9rem;">Go to Company:</label>
    <select name="company" id="dashboard_company" onchange="navigateToCompany()" style="padding:0.3rem 0.5rem; border-radius:4px; border:1px solid #d1d5db; font-size:0.9rem; min-width:180px;">
      <option value="">-- Select Company --</option>
      <option value="new">-- New Company --</option>
      {% for company in all_companies %}
        <option value="{{ company.id }}">{{ company.name }}</option>
      {% endfor %}
    </select>
  </div>
  
  <script>
    function navigateToCompany() {
      const select = document.getElementById('dashboard_company');
      const value = select.value;
      if (value === 'new') {
        window.location.href = '/label_companies/';
      } else if (value) {
        window.location.href = `/label_companies/?company=${value}`;
      }
    }
  </script>

  <!-- Chart and Word Cloud Row -->
  <div class="flex gap-6 mb-5 w-full">
    <!-- Job Search Activity Chart (2/3 width) -->
    <div style="flex: 0 0 66.666%; max-width: 66.666%;">
      <div class="chart-card expanded h-full" id="activityCard" style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">

        <h2>Job Search Activity by Type</h2>
        <div class="date-filter-container">
          <!-- Row 1: Date Range controls -->
          <div class="flex gap-2 items-center mb-2">
            <span class="text-xs font-medium text-gray-700 h-8 inline-flex items-center whitespace-nowrap">Range:</span>
            <input type="date" id="startDateInput" class="text-xs px-2 h-8 border border-gray-300 rounded" />
            <span class="text-xs text-gray-500 h-8 inline-flex items-center">to</span>
            <input type="date" id="endDateInput" class="text-xs px-2 h-8 border border-gray-300 rounded" />
            <select id="quickRange" class="text-xs px-2 h-8 border border-gray-300 rounded bg-white">
              <option value="today" selected>Today</option>
              <option value="all">All</option>
              <option value="7">Last 7 days</option>
              <option value="14">Last 14 days</option>
              <option value="30">Last 30 days</option>
              <option value="60">Last 60 days</option>
              <option value="90">Last 90 days</option>
            </select>
            <button style="background:#6b7280; color:white; border:none; border-radius:4px; padding:0 0.75rem; font-size:0.75rem; height:2rem; cursor:pointer; white-space:nowrap;" onclick="resetActivityDateRange()">Reset</button>
          </div>
          <!-- Row 2: X-Axis and Series -->
          <div class="flex gap-4 items-center">
            <div class="flex gap-2 items-center">
              <span class="text-xs font-medium text-gray-700 h-8 inline-flex items-center whitespace-nowrap">X-Axis:</span>
              <select id="xAxisType" class="text-xs px-2 h-8 border border-gray-300 rounded bg-white">
                <option value="date">Date</option>
                <option value="week">Week</option>
                <option value="month" selected>Month</option>
              </select>
            </div>
            <div class="flex gap-2 items-center relative">
              <span class="text-xs font-medium text-gray-700 h-8 inline-flex items-center whitespace-nowrap">Series:</span>
              <div class="relative">
                <button type="button" id="plotSeriesButton" class="text-xs px-3 h-8 border border-gray-300 rounded bg-white hover:bg-gray-50 inline-flex justify-between items-center gap-2 whitespace-nowrap">
                  <span id="plotSeriesLabel">All Selected</span>
                  <span>‚ñº</span>
                </button>
                <div id="plotSeriesDropdown" style="display:none;" class="absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded shadow-lg z-[1000] min-w-[180px] py-2">
                  {% for series in plot_series_config %}
                  <label class="block px-2 py-1.5 cursor-pointer text-xs text-gray-700 hover:bg-gray-50 whitespace-nowrap">
                    <input type="checkbox" class="series-checkbox mr-2" value="{{ series.key }}" checked data-label="{{ series.label }}" />
                    <span style="color:{{ series.color }};">{{ series.label }}</span>
                  </label>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
        <canvas id="activityChart" height="200"></canvas>
      </div>
    </div>

    <!-- Company Focus Areas Word Cloud (1/3 width) -->
    <div style="flex: 0 0 33.333%; max-width: 33.333%;">
      <div class="h-full" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
        <h2 style="font-size: 0.9rem; color: #1f2937; margin: 0 0 0.75rem 0;">üíº Company Focus Areas</h2>
        <div id="wordCloudContainer" style="flex: 1; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 6px; align-content: center;">
          <!-- Words will be inserted here by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <h1>üìä Gmail Job Tracker Dashboard</h1>
  {% if is_first_time %}
  <div id="first-time-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000;">
    <div style="background:#fff; padding:24px; max-width:560px; width:90%; border-radius:8px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
      <h2 style="margin-top:0;">Welcome new user!</h2>
      <p style="margin-bottom:12px;">You'll need to ensure that you have downloaded your <b>credentials.json</b> file from Google Cloud. Then, update the <b>.env</b> file as needed.</p>
      <p style="margin-bottom:18px;">Click <b>OK</b> to begin ingestion of email from Google. Click <b>Cancel</b> to allow you to double-check the above.</p>
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button id="ft-cancel" style="padding:8px 14px; background:#e5e7eb; border:1px solid #d1d5db; border-radius:6px;">Cancel</button>
        <a id="ft-ok" href="{% url 'reingest_admin' %}" style="padding:8px 14px; background:#2563eb; color:#fff; text-decoration:none; border-radius:6px;">OK</a>
      </div>
    </div>
  </div>
  <script>
    (function(){
      var modal = document.getElementById('first-time-modal');
      var cancelBtn = document.getElementById('ft-cancel');
      if (cancelBtn && modal) {
        cancelBtn.addEventListener('click', function(){ modal.style.display='none'; });
      }
    })();
  </script>
  {% endif %}

  <script>
    // Focus Area Word Cloud
    (function() {
      const wordData = {{ focus_area_wordcloud_data|safe }};
      const container = document.getElementById('wordCloudContainer');
      
      if (!wordData || wordData.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; font-style: italic;">No focus areas set yet. Add focus areas to companies to see the word cloud.</p>';
        return;
      }
      
      // Find max frequency for scaling
      const maxFreq = Math.max(...wordData.map(item => item[1]));
      const minFreq = Math.min(...wordData.map(item => item[1]));
      
      // Generate color palette
      const colors = ['#2563eb', '#7c3aed', '#db2777', '#dc2626', '#ea580c', '#d97706', '#059669', '#0891b2'];
      
      // Create word elements
      wordData.forEach(([word, freq], index) => {
        const link = document.createElement('a');
        link.href = `/job_search_tracker/?focus_area=${encodeURIComponent(word)}`;
        link.textContent = word;
        
        // Scale font size between 0.6rem and 1.2rem based on frequency (smaller for word cloud)
        const fontSize = 0.6 + (freq - minFreq) / (maxFreq - minFreq) * 0.6;
        link.style.fontSize = fontSize + 'rem';
        link.style.color = colors[index % colors.length];
        link.style.fontWeight = freq > maxFreq * 0.7 ? '600' : freq > maxFreq * 0.4 ? '500' : '400';
        link.style.cursor = 'pointer';
        link.style.padding = '0.2rem 0.4rem';
        link.style.transition = 'transform 0.2s, color 0.2s';
        link.style.textDecoration = 'none';
        link.title = `${word}: ${freq} ${freq === 1 ? 'company' : 'companies'} - Click to view in Job Search Tracker`;
        
        // Hover effect
        link.addEventListener('mouseenter', () => {
          link.style.transform = 'scale(1.1)';
          link.style.textDecoration = 'underline';
        });
        link.addEventListener('mouseleave', () => {
          link.style.transform = 'scale(1)';
          link.style.textDecoration = 'none';
        });
        
        container.appendChild(link);
      });
    })();
  </script>

  <!-- Company Breakdown by Status (defaults to last 7 days; adjust with date picker above) -->
  <div style="margin-top: 2rem;">
  {% if selected_company %}
    <div style="margin-bottom:1.5rem;">
      <h2 style="font-size:1rem; color:#2563eb; margin-bottom:0.5rem;">Threads for {{ selected_company.name }}</h2>
      <table style="width:100%; border-collapse:collapse; background:#fff; border-radius:6px; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.07);">
        <thead>
          <tr style="background:#f3f4f6;">
            <th style="padding:0.5rem; text-align:left; font-size:0.85rem; color:#374151;">Initial Date</th>
            <th style="padding:0.5rem; text-align:left; font-size:0.85rem; color:#374151;">Subject</th>
            <th style="padding:0.5rem; text-align:left; font-size:0.85rem; color:#374151;">Label</th>
            <th style="padding:0.5rem; text-align:left; font-size:0.85rem; color:#374151;">Thread</th>
          </tr>
        </thead>
        <tbody>
          {% for thread in threads_by_subject %}
            {% with first_msg=thread.messages.0 %}
            <tr class="thread-row" style="border-bottom:1px solid #e5e7eb;">
              <td style="padding:0.5rem; font-size:0.85rem;">{{ first_msg.timestamp|date:"Y-m-d H:i" }}</td>
              <td style="padding:0.5rem; font-weight:600; color:#2563eb; font-size:0.85rem;">{{ thread.subject }}</td>
              <td style="padding:0.5rem; font-size:0.85rem;">
                <span style="background:#e0e7ff; color:#3730a3; border-radius:4px; padding:0.2rem 0.5rem; font-size:0.75rem;">
                  {{ first_msg.ml_label|default:"N/A" }}
                </span>
              </td>
              <td style="padding:0.5rem; font-size:0.85rem;">
                <details class="thread-details">
                  <summary style="cursor:pointer; font-weight:500; color:#2563eb;">Show Thread ({{ thread.messages|length }})</summary>
                  <ul style="margin:0.5rem 0 0 0; padding:0; list-style:none; font-size:0.85rem;">
                    {% for msg in thread.messages %}
                      <li style="border-bottom:1px solid #e5e7eb; padding:0.5rem 0;">
                        <div style="color:#6b7280; font-size:0.8rem; margin-bottom:0.2rem;">
                          <strong>{{ msg.timestamp|date:"Y-m-d H:i" }}</strong> ‚Äî {{ msg.sender }}
                          <span style="background:#f3f4f6; color:#374151; border-radius:4px; padding:0.15rem 0.4rem; font-size:0.75rem; margin-left:0.5rem;">{{ msg.ml_label|default:"N/A" }}</span>
                        </div>
                        <div style="color:#374151; font-size:0.85rem; white-space:pre-line;">
                          {% if msg.body_html %}
                            {{ msg.body_html|safe }}
                          {% else %}
                            {{ msg.body|linebreaksbr }}
                          {% endif %}
                        </div>
                      </li>
                    {% endfor %}
                  </ul>
                </details>
              </td>
            </tr>
            {% endwith %}
          {% empty %}
            <tr><td colspan="4" style="color:#9ca3af; text-align:center; padding:1rem; font-size:0.85rem;">No threads found for this company.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
  <h2>Companies by Activity Type (filtered entirely by the date range above)</h2>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap; margin-top: 1rem;">
      <!-- Rejections -->
      <div style="flex: 1; min-width: 250px; background: #fef2f2; padding: 1rem; border-radius: 8px; border-left: 4px solid #ef4444;">
        <h3 style="color: #991b1b; margin: 0 0 0.75rem 0; font-size: 1rem; font-weight: 600; display:flex; align-items:center; gap:0.5rem;">
          <span>üö´ Rejections From (<span id="rejectionCount">{{ initial_rejection_companies|length }}</span>)</span>
          <button class="copy-btn" onclick="copyCompanyList('rejectionList', this)">Copy</button>
        </h3>
        <ul id="rejectionList" style="margin: 0; padding-left: 1.25rem; list-style: disc; color: #7f1d1d; font-size: 0.9rem; line-height: 1.6;">
          {% if initial_rejection_companies %}
            {% for c in initial_rejection_companies %}
              <li style="font-size:0.8rem;"><a href="/label_companies/?company={{ c.id }}" style="text-decoration:none; color:inherit;">{{ c.name }}</a></li>
            {% endfor %}
          {% else %}
            <li style="color: #9ca3af; font-size:0.8rem;">No data in selected range</li>
          {% endif %}
        </ul>
      </div>

      <!-- Applications Sent -->
      <div style="flex: 1; min-width: 250px; background: #eff6ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #2563eb;">
        <h3 style="color: #1e40af; margin: 0 0 0.75rem 0; font-size: 1rem; font-weight: 600; display:flex; align-items:center; gap:0.5rem;">
          <span>üì§ Applications Sent to (distinct companies) (<span id="applicationCount">{{ initial_application_companies|length }}</span>)</span>
          <button class="copy-btn" onclick="copyCompanyList('applicationList', this)">Copy</button>
        </h3>
        <ul id="applicationList" style="margin: 0; padding-left: 1.25rem; list-style: disc; color: #1e3a8a; font-size: 0.9rem; line-height: 1.6;">
          {% if initial_application_companies %}
            {% for c in initial_application_companies %}
              <li style="font-size:0.8rem;"><a href="/label_companies/?company={{ c.id }}" style="text-decoration:none; color:inherit;">{{ c.name }}{% if c.count %} ({{ c.count }}){% endif %}</a></li>
            {% endfor %}
          {% else %}
            <li style="color: #9ca3af; font-size:0.8rem;">No data in selected range</li>
          {% endif %}
        </ul>
      </div>

      <!-- Ghosted By (Always Visible - Shows Current Total) -->
      <div id="ghostedSection" style="flex: 1; min-width: 250px; background: #f5f5f5; padding: 1rem; border-radius: 8px; border-left: 4px solid #737373;">
        <h3 style="color: #404040; margin: 0 0 0.75rem 0; font-size: 1rem; font-weight: 600; display:flex; align-items:center; gap:0.5rem;">
          <span>üëª Ghosted By (<span id="ghostedCount">{{ ghosted_count }}</span>)</span>
          <button class="copy-btn" onclick="copyCompanyList('ghostedList', this)">Copy</button>
        </h3>
        <ul id="ghostedList" style="margin: 0; padding-left: 1.25rem; list-style: disc; color: #525252; font-size: 0.9rem; line-height: 1.6;">
          {% if ghosted_companies_list %}
            {% for c in ghosted_companies_list %}
              <li style="font-size:0.8rem;"><a href="/label_companies/?company={{ c.id }}" style="text-decoration:none; color:inherit;">{{ c.name }}</a></li>
            {% endfor %}
          {% else %}
            <li style="color: #9ca3af; font-size:0.8rem;">No companies currently ghosted</li>
          {% endif %}
        </ul>
      </div>
      <!-- Interviews -->
      <div style="flex: 1; min-width: 250px; background: #e0f7fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #22c55e;">
        <h3 style="color: #0d9488; margin: 0 0 0.75rem 0; font-size: 1rem; font-weight: 600; display:flex; align-items:center; gap:0.5rem;">
          <span>üóìÔ∏è Interviews With (includes upcoming) (<span id="interviewCount">{{ initial_interview_companies|length }}</span>)</span>
          <button class="copy-btn" onclick="copyCompanyList('interviewList', this)">Copy</button>
        </h3>
        <ul id="interviewList" style="margin: 0; padding-left: 1.25rem; list-style: disc; color: #0d9488; font-size: 0.9rem; line-height: 1.6;">
          {% if initial_interview_companies %}
            {% for c in initial_interview_companies %}
              <li style="font-size:0.8rem;"><a href="/label_companies/?company={{ c.id }}" style="text-decoration:none; color:inherit;">{{ c.name }}</a></li>
            {% endfor %}
          {% else %}
            <li style="color: #9ca3af; font-size:0.8rem;">No data in selected range</li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Company breakdown data from Django (declare early so downstream code can use it)
    const rejectionCompanies = {{ rejection_companies_json|safe }};
    const applicationCompanies = {{ application_companies_json|safe }};
    const ghostedCompanies = {{ ghosted_companies_json|safe }};
  const interviewCompanies = {{ interview_companies_json|safe }};
  console.log('Interview companies:', interviewCompanies);
    console.log('Rejection companies:', rejectionCompanies);
    console.log('Application companies:', applicationCompanies);
    console.log('Ghosted companies:', ghostedCompanies);

    // Removed Ingestion Stats Chart (Line)

    // Application Activity Chart (Line)
  {% if chart_activity_labels %}
    // Store full dataset
    const fullActivityLabels = {{ chart_activity_labels|safe }};
  // Dynamic series data from server (each item includes key, label, color, data)
  const seriesConfig = {{ plot_series_config|safe }}; // used for checkboxes only
  const seriesData = {{ chart_series_data|safe }};
    
    // Build datasets array dynamically
    const activityDatasets = seriesData.map((series) => ({
      key: series.key,
      label: series.label,
      data: series.data.map(Number),
      backgroundColor: series.color + 'cc', // More opaque for bars
      borderColor: series.color,
      borderWidth: 1
    }));
    
    let activityChart = null;
    try {
      const ctxActivity = document.getElementById('activityChart').getContext('2d');
      activityChart = new Chart(ctxActivity, {
        type: 'bar',
        data: {
          labels: fullActivityLabels,
          datasets: activityDatasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { font: { size: 10 } }
            },
            title: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              bodyFont: { size: 10 }
            }
          },
          scales: {
            x: { 
              display: true,
              ticks: { font: { size: 9 } },
              title: { display: false }
            },
            y: { 
              beginAtZero: true,
              ticks: { font: { size: 9 } },
              title: { display: false }
            }
          }
        }
      });
    } catch (e) {
      console.warn('Activity chart failed to initialize:', e);
    }
  // Date filter controls
    const startDateInput = document.getElementById('startDateInput');
    const endDateInput = document.getElementById('endDateInput');
    const quickRange = document.getElementById('quickRange');


    const minDateStr = fullActivityLabels[0];
    const maxDateStr = fullActivityLabels[fullActivityLabels.length - 1];

    // Set input bounds
    startDateInput.min = minDateStr;
    startDateInput.max = maxDateStr;
    endDateInput.min = minDateStr;
    endDateInput.max = maxDateStr;

    // Initialize to today's date (default)
    const today = new Date();
    const todayStr = formatDate(today);
    const clampedToday = clampDateStr(todayStr);
    
    startDateInput.value = clampedToday;
    endDateInput.value = clampedToday;

    function clampDateStr(str) {
      if (str < minDateStr) return minDateStr;
      if (str > maxDateStr) return maxDateStr;
      return str;
    }

    function formatDate(d) {
      const pad = (n) => String(n).padStart(2, '0');
      const y = d.getFullYear();
      const m = pad(d.getMonth() + 1);
      const day = pad(d.getDate());
      return `${y}-${m}-${day}`;
    }

    function findStartIdx(dateStr) {
      // first index with label >= dateStr
      for (let i = 0; i < fullActivityLabels.length; i++) {
        if (fullActivityLabels[i] >= dateStr) return i;
      }
      return 0;
    }

    function findEndIdx(dateStr) {
      // last index with label <= dateStr
      for (let i = fullActivityLabels.length - 1; i >= 0; i--) {
        if (fullActivityLabels[i] <= dateStr) return i;
      }
      return fullActivityLabels.length - 1;
    }

    function groupLabelsAndData(labels, dataArrays, type) {
      // type: 'date', 'week', 'month'
      if (type === 'date') {
        return { labels, dataArrays };
      }
      const grouped = {};
      const labelMap = [];
      for (let i = 0; i < labels.length; i++) {
        let key;
        if (type === 'week') {
          // YYYY-Www (ISO week)
          const d = new Date(labels[i] + 'T00:00:00');
          const y = d.getFullYear();
          // get week number
          const firstDay = new Date(d.getFullYear(), 0, 1);
          const pastDaysOfYear = (d - firstDay) / 86400000;
          key = y + '-W' + String(Math.ceil((pastDaysOfYear + firstDay.getDay()+1)/7)).padStart(2,'0');
        } else if (type === 'month') {
          // YYYY-MM
          const d = new Date(labels[i] + 'T00:00:00');
          key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
        }
        if (!grouped[key]) {
          grouped[key] = dataArrays.map(() => 0);
          labelMap.push(key);
        }
        for (let j = 0; j < dataArrays.length; j++) {
          grouped[key][j] += dataArrays[j][i];
        }
      }
      // Return grouped labels and arrays
      const newDataArrays = dataArrays.map((_, idx) => labelMap.map(l => grouped[l][idx]));
      return { labels: labelMap, dataArrays: newDataArrays };
    }

    function updateActivityChartByDates() {
      let startStr = clampDateStr(startDateInput.value || minDateStr);
      let endStr = clampDateStr(endDateInput.value || maxDateStr);

      // Ensure start <= end; if not, swap
      if (startStr > endStr) {
        const tmp = startStr; startStr = endStr; endStr = tmp;
        startDateInput.value = startStr;
        endDateInput.value = endStr;
      }

      const startIdx = findStartIdx(startStr);
      const endIdx = findEndIdx(endStr);

      let slicedLabels = fullActivityLabels.slice(startIdx, endIdx + 1);
      
      // Slice all series data dynamically
      let slicedSeriesData = seriesData.map(series => series.data.slice(startIdx, endIdx + 1));

      // If slice empty due to an edge case, fallback to full
      if (slicedLabels.length === 0) {
        slicedLabels = fullActivityLabels;
        slicedSeriesData = seriesData.map(series => series.data);
      }

      // Calculate date range in days
      const startDate = new Date(startStr + 'T00:00:00');
      const endDate = new Date(endStr + 'T00:00:00');
      const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

      // Get user's selected X-axis type (respect user's choice)
      const xAxisTypeSelect = document.getElementById('xAxisType');
      let xAxisType = xAxisTypeSelect.value;
      
      const grouped = groupLabelsAndData(
        slicedLabels,
        slicedSeriesData,
        xAxisType
      );

      // Series selection from custom checkbox dropdown
      const seriesCheckboxes = document.querySelectorAll('.series-checkbox');
      const selectedKeys = Array.from(seriesCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      activityChart.data.labels = grouped.labels;
      // Update datasets and hide/show based on selection, aligned by dataset order
      activityChart.data.datasets.forEach((ds, idx) => {
        ds.data = grouped.dataArrays[idx];
        ds.hidden = !selectedKeys.includes(ds.key);
      });
      activityChart.update();
      
      // ‚úÖ Update company breakdown lists based on date range
      updateCompanyBreakdown(startStr, endStr);
    }
    
    // Update button label based on selected checkboxes
    function updatePlotSeriesLabel() {
      const checkboxes = document.querySelectorAll('.series-checkbox');
      const checked = Array.from(checkboxes).filter(cb => cb.checked);
      const label = document.getElementById('plotSeriesLabel');
      
      if (checked.length === 0) {
        label.textContent = 'None Selected';
      } else if (checked.length === checkboxes.length) {
        label.textContent = 'All Selected';
      } else {
        label.textContent = `${checked.length} Selected`;
      }
    }
    
  // X-axis type change handler
  document.getElementById('xAxisType').addEventListener('change', updateActivityChartByDates);
  
  // Plot Series dropdown toggle
  const plotSeriesButton = document.getElementById('plotSeriesButton');
  const plotSeriesDropdown = document.getElementById('plotSeriesDropdown');
  
  plotSeriesButton.addEventListener('click', (e) => {
    e.stopPropagation();
    plotSeriesDropdown.style.display = plotSeriesDropdown.style.display === 'none' ? 'block' : 'none';
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', () => {
    plotSeriesDropdown.style.display = 'none';
  });
  
  plotSeriesDropdown.addEventListener('click', (e) => {
    e.stopPropagation();
  });
  
  // Series selection change handler - attach to all checkboxes
  document.querySelectorAll('.series-checkbox').forEach(cb => {
    cb.addEventListener('change', () => {
      updatePlotSeriesLabel();
      updateActivityChartByDates();
    });
  });

    // Quick range handler
    quickRange.addEventListener('change', () => {
      const val = quickRange.value;
      if (val === 'today') {
        const today = new Date();
        const todayStr = clampDateStr(formatDate(today));
        startDateInput.value = todayStr;
        endDateInput.value = todayStr;
      } else if (val === 'all') {
        startDateInput.value = minDateStr;
        endDateInput.value = maxDateStr;
      } else {
        const days = parseInt(val, 10);
        // end is the max date by default
        const end = new Date(maxDateStr + 'T00:00:00');
        const start = new Date(end);
        start.setDate(start.getDate() - (days - 1));
        const startStr = clampDateStr(formatDate(start));
        startDateInput.value = startStr;
        endDateInput.value = maxDateStr;
      }
      updateActivityChartByDates();
    });

    // Input change handlers
    startDateInput.addEventListener('change', () => {
      // Clear quick range selection when manually edited
      quickRange.value = 'all';
      updateActivityChartByDates();
    });
    endDateInput.addEventListener('change', () => {
      quickRange.value = 'all';
      updateActivityChartByDates();
    });

    function resetActivityDateRange() {
      quickRange.value = 'today';
      const today = new Date();
      const todayStr = clampDateStr(formatDate(today));
      startDateInput.value = todayStr;
      endDateInput.value = todayStr;
      updateActivityChartByDates();
    }

    // Initialize chart with full range
    updateActivityChartByDates();
  {% endif %}

    function toDayNumber(dateStr) {
      // Converts 'YYYY-MM-DD' to a local day number (ms since epoch at 00:00 local)
      if (!dateStr || typeof dateStr !== 'string') return NaN;
      // Ensure ISO-like format; incoming data is serialized as 'YYYY-MM-DD'
      return new Date(dateStr + 'T00:00:00').getTime();
    }

    function updateCompanyBreakdown(startStr, endStr) {
      console.log('=== updateCompanyBreakdown called ===');
      console.log('Filtering by date range:', startStr, 'to', endStr);
      console.log('Raw data counts:', {
        rejections: rejectionCompanies?.length,
        applications: applicationCompanies?.length,
        ghosted: ghostedCompanies?.length,
        interviews: interviewCompanies?.length
      });

      // Derive date range from datasets if not provided
      const startDateInput = document.getElementById('startDateInput');
      const endDateInput = document.getElementById('endDateInput');
      if (!startStr || !endStr) {
        const dates = [];
        try {
          (rejectionCompanies || []).forEach(i => { if (i && i.rejection_date) dates.push(i.rejection_date); });
          (applicationCompanies || []).forEach(i => { if (i && i.sent_date) dates.push(i.sent_date); });
          (ghostedCompanies || []).forEach(i => { if (i && i.sent_date) dates.push(i.sent_date); });
          (interviewCompanies || []).forEach(i => { if (i && i.interview_date) dates.push(i.interview_date); });
        } catch (e) {
          console.warn('Could not derive dates for fallback:', e);
        }
        if (dates.length) {
          dates.sort();
          startStr = dates[0];
          endStr = dates[dates.length - 1];
          if (startDateInput) {
            startDateInput.min = startStr; startDateInput.max = endStr; startDateInput.value = startStr;
          }
          if (endDateInput) {
            endDateInput.min = startStr; endDateInput.max = endStr; endDateInput.value = endStr;
          }
        }
      }
      // Normalize bounds to day numbers for reliable comparisons
      const startNum = toDayNumber(startStr);
      const endNum = toDayNumber(endStr);

      console.log('Date range converted:', {
        startStr, endStr,
        startNum, endNum,
        startDate: new Date(startNum),
        endDate: new Date(endNum)
      });

      // Log sample data for debugging
      if (interviewCompanies && interviewCompanies.length > 0) {
        console.log('Sample interview data:', interviewCompanies.slice(0, 3).map(item => ({
          company: item.company__name,
          date: item.interview_date,
          dateNum: toDayNumber(item.interview_date)
        })));
      }
      if (ghostedCompanies && ghostedCompanies.length > 0) {
        console.log('Sample ghosted data:', ghostedCompanies.slice(0, 3).map(item => ({
          company: item.company__name,
          date: item.sent_date,
          dateNum: toDayNumber(item.sent_date)
        })));
      }

      // Filter companies by date range, keep id+name (inclusive bounds)
      const rejections = rejectionCompanies
        .filter(item => {
          const d = toDayNumber(item.rejection_date);
          const matched = !isNaN(d) && !isNaN(startNum) && !isNaN(endNum) && d >= startNum && d <= endNum;
          if (matched) console.log('Rejection matched:', item.company__name, item.rejection_date);
          return matched;
        })
        .map(item => ({ id: item.company_id, name: item.company__name }));
      
      // Filter applications by date range, then group by company with counts
      const applications = applicationCompanies
        .filter(item => {
          const d = toDayNumber(item.sent_date);
          const matched = !isNaN(d) && !isNaN(startNum) && !isNaN(endNum) && d >= startNum && d <= endNum;
          if (matched) console.log('Application matched:', item.company__name, item.sent_date);
          return matched;
        })
        .map(item => ({ id: item.company_id, name: item.company__name }));
      
      // Ghosted: Filter by date range like other metrics for consistency
      const ghosted = (ghostedCompanies || []).filter(item => {
        const d = toDayNumber(item.sent_date);
        const matched = !isNaN(d) && !isNaN(startNum) && !isNaN(endNum) && d >= startNum && d <= endNum;
        if (matched) console.log('Ghosted matched:', item.company__name, item.sent_date);
        return matched;
      }).map(item => ({ id: item.company_id, name: item.company__name }));
      
      console.log('Filtered ghosted companies:', ghosted.length);
      
      const interviews = interviewCompanies
        .filter(item => {
          const d = toDayNumber(item.interview_date);
          const matched = !isNaN(d) && !isNaN(startNum) && !isNaN(endNum) && d >= startNum && d <= endNum;
          if (matched) console.log('Interview matched:', item.company__name, item.interview_date);
          return matched;
        })
        .map(item => ({ id: item.company_id, name: item.company__name }));

      console.log('Filtered rejections:', rejections);
      console.log('Filtered applications:', applications);
      console.log('All ghosted (no date filter):', ghosted);

      // Get unique companies by id (deduplicate)
      function uniqueById(arr) {
        const map = new Map();
        for (const item of arr) {
          if (item && item.id != null && !map.has(item.id)) {
            map.set(item.id, item);
          }
        }
        return Array.from(map.values());
      }
  const uniqueRejections = uniqueById(rejections);
  const uniqueApplications = uniqueById(applications);
  const uniqueGhosted = uniqueById(ghosted);
  const uniqueInterviews = uniqueById(interviews);

      // Update DOM
    const rejectionList = document.getElementById('rejectionList');
    const applicationList = document.getElementById('applicationList');
    const ghostedList = document.getElementById('ghostedList');
    const interviewList = document.getElementById('interviewList');
    const rejectionCount = document.getElementById('rejectionCount');
    const applicationCount = document.getElementById('applicationCount');
    const ghostedCount = document.getElementById('ghostedCount');
    const interviewCount = document.getElementById('interviewCount');

      // Helper to render list
      function renderList(listEl, companies, countsMap, annotateCounts=true) {
        if (companies.length === 0) {
          listEl.innerHTML = '<li style="color: #9ca3af;">No data in selected range</li>';
          return;
        }
        const sorted = companies.slice().sort((a,b) => a.name.localeCompare(b.name));
        listEl.innerHTML = sorted
          .map(item => {
            const c = countsMap.get(item.id) || 1;
            const suffix = annotateCounts && c > 1 ? ` (${c})` : '';
            return `<li><a href="/label_companies/?company=${item.id}" style="text-decoration:none; color:inherit;">${item.name}${suffix}</a></li>`;
          })
          .join('');
      }

      // Build frequency maps for each category (exclude ghosted per requirement unless future request)
      function buildCounts(arr) {
        const m = new Map();
        arr.forEach(e => {
          if (!e || e.id == null) return;
          m.set(e.id, (m.get(e.id) || 0) + 1);
        });
        return m;
      }

      const rejectionCounts = buildCounts(rejections);
      const applicationCounts = buildCounts(applications);
      const interviewCounts = buildCounts(interviews);
      const ghostedCounts = buildCounts(ghosted); // not annotated (spec only asked for rejections/interviews/applications)

      renderList(rejectionList, uniqueRejections, rejectionCounts);
      renderList(applicationList, uniqueApplications, applicationCounts);
      renderList(ghostedList, uniqueGhosted, ghostedCounts, false);
      renderList(interviewList, uniqueInterviews, interviewCounts);

      // Update counts
  if (rejectionCount) rejectionCount.textContent = String(uniqueRejections.length);
  if (applicationCount) applicationCount.textContent = String(uniqueApplications.length);
  if (ghostedCount) ghostedCount.textContent = String(uniqueGhosted.length);
  if (interviewCount) interviewCount.textContent = String(uniqueInterviews.length);
  
  // Update ghosted card count in summary bar
  const ghostedCardCount = document.getElementById('ghostedCardCount');
  if (ghostedCardCount) ghostedCardCount.textContent = String(uniqueGhosted.length);
    }

    // Copy helper
    function copyCompanyList(listId, btnEl) {
      const listEl = document.getElementById(listId);
      if (!listEl) return;
      const items = Array.from(listEl.querySelectorAll('li'))
        .map(li => (li.querySelector('a') ? li.querySelector('a').textContent.trim() : li.textContent.trim()))
        .filter(t => t && t.toLowerCase() !== 'no data in selected range');
      const text = items.join('\n');
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        if (btnEl) {
          const prev = btnEl.textContent;
          btnEl.textContent = 'Copied!';
          setTimeout(() => (btnEl.textContent = prev), 1200);
        }
      }).catch(() => {
        // Fallback: prompt
        window.prompt('Copy the list:', text);
      });
    }

    // Expand/collapse chart cards
    // Removed expand/collapse logic for activity chart; always expanded

    // Initialize lists at least once after DOM is ready
    (function(){
      function initLists() {
        const sEl = document.getElementById('startDateInput');
        const eEl = document.getElementById('endDateInput');
        const sVal = sEl && sEl.value;
        const eVal = eEl && eEl.value;
        updateCompanyBreakdown(sVal, eVal);
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLists);
      } else {
        initLists();
      }
    })();

    // Auto-close other thread details when one is opened
    document.addEventListener('click', function(e) {
      if (e.target.tagName === 'SUMMARY') {
        const allDetails = document.querySelectorAll('.thread-details');
        allDetails.forEach(details => {
          if (details !== e.target.parentElement && details.open) {
            details.open = false;
          }
        });
      }
    });
  </script>
{% endblock %}