{% extends "base.html" %}
{% block title %}Compare Gmail Filters{% endblock %}
{% block content %}
<div class="main-content">
  <h1>Compare Gmail Filters</h1>
  
  {% if debug_mappings %}
  <details style="margin-bottom:1.5rem; border:1px solid #d1d5db; border-radius:8px; padding:1rem; background:#f9fafb;">
    <summary style="cursor:pointer; font-weight:600; color:#2563eb;">üîç Debug: Label Mappings ({{ debug_mappings|length }} total)</summary>
    <table style="margin-top:1rem; width:100%; border-collapse:collapse; font-size:0.9em;">
      <thead>
        <tr style="background:#e5e7eb;">
          <th style="padding:0.5rem; text-align:left; border:1px solid #d1d5db;">Gmail Label</th>
          <th style="padding:0.5rem; text-align:left; border:1px solid #d1d5db;">Display Label</th>
          <th style="padding:0.5rem; text-align:left; border:1px solid #d1d5db;">Base Key</th>
          <th style="padding:0.5rem; text-align:left; border:1px solid #d1d5db;">Internal Label</th>
          <th style="padding:0.5rem; text-align:left; border:1px solid #d1d5db;">Source</th>
        </tr>
      </thead>
      <tbody>
        {% for m in debug_mappings %}
        <tr style="{% if m.internal == 'UNMAPPED' %}background:#fee2e2;{% endif %}">
          <td style="padding:0.5rem; border:1px solid #d1d5db;">{{ m.gmail_label }}</td>
          <td style="padding:0.5rem; border:1px solid #d1d5db;">{{ m.display_label }}</td>
          <td style="padding:0.5rem; border:1px solid #d1d5db;">{{ m.base_key }}</td>
          <td style="padding:0.5rem; border:1px solid #d1d5db; font-weight:{% if m.internal == 'UNMAPPED' %}bold{% else %}normal{% endif %}; color:{% if m.internal == 'UNMAPPED' %}#dc2626{% else %}#059669{% endif %};">{{ m.internal }}</td>
          <td style="padding:0.5rem; border:1px solid #d1d5db;">{{ m.source }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if unmapped_labels %}
    <div style="margin-top:1rem; padding:1rem; background:#fef2f2; border:1px solid #fca5a5; border-radius:6px;">
      <strong style="color:#dc2626;">‚ö†Ô∏è Unmapped Labels ({{ unmapped_labels|length }}):</strong>
      <ul style="margin:0.5rem 0 0 1.5rem; color:#991b1b;">
        {% for label in unmapped_labels %}
        <li>{{ label }}</li>
        {% endfor %}
      </ul>
      <p style="margin-top:0.5rem; font-size:0.9em; color:#6b7280;">
        Add these to <code>json/gmail_label_map.json</code> or update the synonyms in <code>tracker/views.py</code> to map them.
      </p>
    </div>
    {% endif %}
  </details>
  {% endif %}
  
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
      <div>
        <label for="gmail_label_prefix" style="font-weight:600;">Label Prefix</label>
        <input id="gmail_label_prefix" name="gmail_label_prefix" type="text" value="{{ gmail_label_prefix|default:'#job-hunt' }}" placeholder="#job-hunt" style="width:180px; padding:0.5rem; border:1px solid #d1d5db; border-radius:6px; margin-left:0.5rem;" />
      </div>
  <button class="button" name="action" value="import_gmail_filters" type="submit" style="background:#2563eb; color:#fff; font-weight:600; border:none; border-radius:6px; padding:0.6rem 1.2rem;">Compare Filters</button>
    </div>
    <div style="margin-bottom:1rem;">
      <label><input type="checkbox" id="select_all" onclick="toggleAll(this)"> Select All Filters</label>
    </div>
    <div>
      {% for f in filters %}
      <div style="border:1px solid #e5e7eb; border-radius:8px; margin-bottom:1.5rem; padding:1rem; background:#f9fafb;">
        <div style="display:flex; align-items:center; margin-bottom:0.5rem;">
          <input type="checkbox" name="update_{{ forloop.counter0 }}" {% if f.checked %}checked{% endif %} style="margin-right:0.75em;" />
          <textarea readonly rows="1" style="font-weight:600; font-size:1.1em; width:350px; max-width:100%; min-width:120px; resize:vertical; overflow:auto; background:transparent; border:none; outline:none; padding:0; margin:0; word-break:break-all; white-space:pre-wrap;">{{ f.label }}</textarea>
        </div>
        <div style="display:flex; gap:1.5em;">
          <div style="flex:1;">
            <div style="font-size:0.95em; color:#6b7280; margin-bottom:0.25em;">Gmail Filter Rule</div>
            <textarea readonly rows="3" style="width:100%; background:#f3f4f6; border-radius:4px; padding:0.5em; word-break:break-all; white-space:pre-wrap; resize:vertical; overflow:auto;">{{ f.gmail_rule }}</textarea>
          </div>
          <div style="flex:1;">
            <div style="font-size:0.95em; color:#6b7280; margin-bottom:0.25em;">Installed Pattern (Editable)</div>
            <textarea name="installed_pattern_{{ forloop.counter0 }}" rows="3" style="width:100%; background:#fffbe6; border-radius:4px; padding:0.5em; border:1px solid #f59e42; word-break:break-all; white-space:pre-wrap; resize:vertical; overflow:auto;">{{ f.installed_rule }}</textarea>
            {# Diff box hidden for now #}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <input type="hidden" name="gmail_label_prefix" value="{{ gmail_label_prefix }}" />
  <button class="button" name="action" value="apply_selected_filters" type="submit" style="background:#059669; float:right; margin-top:1.5em;">Apply Selected Filters</button>
  </form>
</div>
<script>
function toggleAll(source) {
  checkboxes = document.querySelectorAll('input[type="checkbox"][name^="update_"]');
  for (var i = 0; i < checkboxes.length; i++) {
    checkboxes[i].checked = source.checked;
  }
}
</script>
{% endblock %}
