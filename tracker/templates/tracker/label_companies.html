{% extends "base.html" %}
{% block title %}Label Companies - GmailJobTracker{% endblock %}
{% block extra_head %}
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 0; background: #f9fafb; color: #333; }
    .dashboard-layout { display: flex; gap: 0.5rem; margin: 0; }
    .sidebar { flex: 0 0 220px; max-width: 240px; }
    .main-content { flex: 1; padding: 2rem 2rem 2rem 0.5rem; }
    h1 { color: #1f2937; margin-bottom: 1.5rem; font-size: 1.5rem; }
    .company-select { margin-bottom: 2rem; display: flex; align-items: center; gap: 1rem; }
    select { padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid #d1d5db; font-size: 1rem; min-width: 220px; }
    .edit-form { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.07); padding: 1.5rem 2rem; max-width: 500px; }
    .edit-form label { font-weight: 500; display: block; margin-top: 1rem; }
    .edit-form input, .edit-form select { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db; font-size: 1rem; margin-top: 0.3rem; }
    .edit-form button { background: #2563eb; color: white; font-weight: 600; padding: 0.6rem 1.2rem; border: none; border-radius: 6px; cursor: pointer; margin-top: 1.5rem; font-size: 1rem; }
    .edit-form button:hover { background: #1e40af; }
    .label-info { margin-top: 1.5rem; font-size: 0.95rem; color: #2563eb; }
    .messages { margin-bottom: 1.5rem; }
    .message { padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .message.success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
    .message.error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
    .message.info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
  </style>
{% endblock %}
{% block content %}
  <div style="display: flex; flex-direction: column; height: calc(100vh - 4rem); overflow: hidden;">
    <!-- Header Section -->
    <div style="flex-shrink: 0; margin-bottom: 1rem;">
      <h1>Label Companies</h1>
      
      <form method="get" class="company-select">
        <label for="company">Select Company:</label>
        <select name="company" id="company" onchange="this.form.submit()">
          <option value="">-- Choose a company --</option>
          <option value="new" {% if creating_new_company %}selected{% endif %}>-- Create New Company --</option>
          {% for c in company_list %}
            <option value="{{ c.id }}" {% if selected_company and c.id == selected_company.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </form>
    </div>

    <!-- Scrollable Company Edit Form Content -->
    <div style="flex: 1; overflow-y: auto; padding-right: 0.5rem;">
      {% if selected_company or creating_new_company %}
      {% if creating_new_company %}
      <!-- Creating New Company Form -->
      <div style="background:#f0fdf4; border:1px solid #86efac; border-radius:8px; padding:1rem 1.5rem; margin-bottom:1.5rem;">
        <h2 style="margin:0 0 0.75rem 0; color:#166534; font-size:1.1rem;">‚ú® Create New Company: {{ new_company_name }}</h2>
        <p style="color:#4b5563; margin:0; font-size:0.95rem;">Fill in the details below and click <strong>Create Company</strong> to save. At least a domain or homepage is required.</p>
      </div>
      <div style="display: flex; gap: 2rem; align-items: flex-start;">
        <div style="flex: 1;">
          <form method="post" action="{% url 'label_companies' %}?company=new&new_company_name={{ new_company_name|urlencode }}" class="edit-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_new_company" />
          <label for="id_name">Company Name</label>
          {{ form.name }}
          <label for="id_focus_area">Focus Area</label>
          {{ form.focus_area }}
          <small style="color:#6b7280; display:block; margin-top:0.25rem; margin-bottom:0.5rem;">Business focus (e.g., Software as a Service, Mining, Network Security)</small>
          <label for="id_domain">Domain Name <span style="color:#b91c1c;">*</span></label>
          {{ form.domain }}
          <small style="color:#6b7280; display:block; margin-bottom:0.5rem;">Enter the company's email domain (e.g., microsoft.com)</small>
          <label for="id_ats">ATS Domain (if any)</label>
          {{ form.ats }}
          <label for="id_homepage">Homepage <span style="color:#b91c1c;">*</span></label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            {{ form.homepage }}
            <button type="submit" name="action" value="populate_from_homepage" style="background:#059669; color:white; font-weight:600; border-radius:6px; padding:0.6rem 1rem; border:none; cursor:pointer; white-space:nowrap;" title="Scrape company info from homepage">üîç Populate</button>
          </div>
          <small style="color:#6b7280; display:block; margin-top:0.25rem; margin-bottom:0.5rem;">Enter URL and click Populate to auto-fill, or fill manually</small>
          <label for="id_career_url">Career/Jobs URL</label>
          {{ form.career_url }}
          <label for="id_alias">Alias (Optional)</label>
          {{ form.alias }}
          <small style="color:#6b7280; display:block; margin-top:0.25rem; margin-bottom:0.5rem;">Alternative name(s) or abbreviation(s). Separate multiple aliases with commas (e.g., 'AFS, Accenture Fed')</small>
          <label for="id_contact_name">Contact Name</label>
          {{ form.contact_name }}
          <label for="id_contact_email">Contact Email</label>
          {{ form.contact_email }}
          <label for="id_status">Status</label>
          {{ form.status }}
          <div style="display:flex; gap:0.75rem; margin-top:1rem;">
            <button type="submit" name="action" value="create_new_company" style="background:#16a34a; color:white; font-weight:600; border-radius:6px; padding:0.6rem 1.2rem; border:none; cursor:pointer;">‚úÖ Create Company</button>
            <a href="{% url 'label_companies' %}" style="background:#6b7280; color:white; font-weight:600; border-radius:6px; padding:0.6rem 1.2rem; text-decoration:none; display:inline-block;">Cancel</a>
          </div>
        </form>
        </div>
        <div style="flex: 1; display: flex; flex-direction: column; gap: 1rem;">
          <!-- Notes Section (expandable) -->
          <details open style="background: #fefce8; border-radius: 8px; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
            <summary style="cursor: pointer; padding: 1rem 1.5rem; font-weight: 600; color: #854d0e; font-size: 1rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
              <span style="transition: transform 0.2s;">‚ñ∂</span> Notes
            </summary>
            <div style="padding: 0 1.5rem 1.5rem 1.5rem;">
              <label for="id_notes" style="display: block; font-weight: 600; color: #854d0e; margin-bottom: 0.5rem;">Company Notes</label>
              {{ form.notes }}
              <small style="color:#6b7280; display:block; margin-top:0.5rem;">Company focus area analysis will appear here after clicking Populate. You can also add your own notes.</small>
            </div>
          </details>
          
          <div style="background: #f3f4f6; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
            <h2 style="margin-top:0; color:#1e40af; font-size:1.1rem;">Tips</h2>
            <ul style="margin:0.5rem 0 0 0; padding-left:1.2rem; font-size:0.95rem; color:#4b5563;">
              <li>At least one of Domain or Homepage is required</li>
              <li>Domain should be the email domain (e.g., google.com)</li>
              <li>ATS Domain is for Applicant Tracking Systems like greenhouse.io</li>
              <li>Status will default to "application" if not set</li>
            </ul>
          </div>
        </div>
      </div>
      {% else %}
      <!-- Existing Company Edit Form -->
      <!-- DEBUG: Company ID={{ selected_company.id }}, Name={{ selected_company.name }}, creating_new_company={{ creating_new_company }} -->
      <div id="companyContent" style="background:#d1fae5; border:2px solid #10b981; border-radius:8px; padding:0.75rem 1.5rem; margin-bottom:1rem;">
        <div style="font-weight:600; font-size:1rem; color:#065f46;">
          üìã Company Profile: {{ selected_company.name }}
        </div>
      </div>
      <!-- Company Metrics and Quick Actions at the top -->
      <div style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:1rem 1.5rem; margin-bottom:1.5rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
          <h2 style="margin:0; color:#1e40af; font-size:1.1rem;">Company Metrics</h2>
          <div style="display:flex; gap:0.5rem;">
            <form method="post" style="margin:0;">
              {% csrf_token %}
              <input type="hidden" name="company" value="{{ selected_company.id }}" />
              <button type="submit" name="action" value="reingest_company" style="background:#ca8a04; color:white; font-weight:600; border-radius:6px; padding:0.45rem 1rem; border:none; cursor:pointer;" title="Re-ingest all messages from this company">üîÑ Re-ingest</button>
            </form>
            {# Status is now auto-calculated based on latest message and GHOSTED_DAYS_THRESHOLD #}
            <a href="{% url 'manual_entry' %}?company={{ selected_company.id }}" style="background:#2563eb; color:white; font-weight:600; border-radius:6px; padding:0.45rem 1rem; border:none; cursor:pointer; text-decoration:none; display:inline-block;" title="Create a new application for this company">‚ûï Create Application</a>
            <form method="get" action="{% url 'delete_company' selected_company.id %}" style="margin:0;">
              <button type="submit" style="background:#b91c1c; color:white; font-weight:600; border-radius:6px; padding:0.45rem 1rem; border:none; cursor:pointer;">Delete Company</button>
            </form>
          </div>
        </div>
        <div style="display:flex; flex-wrap:wrap; gap:1.5rem;">
          <div>
            <strong style="display:block; font-size:0.85rem; color:#6b7280; margin-bottom:0.2rem;">Company Status:</strong>
            <span style="background:#f3f4f6; color:#111827; border-radius:4px; padding:0.25rem 0.6rem; font-size:0.95rem; border:1px solid #e5e7eb; display:inline-block;">{{ selected_company.status|default:"application" }}</span>
          </div>
          <div>
            <strong style="display:block; font-size:0.85rem; color:#6b7280; margin-bottom:0.2rem;">Latest Label from Messages:</strong>
            <span style="background:#e0e7ff; color:#3730a3; border-radius:4px; padding:0.25rem 0.6rem; font-size:0.95rem; display:inline-block;">{{ latest_label|default:"N/A" }}</span>
          </div>
          <div>
            <strong style="display:block; font-size:0.85rem; color:#6b7280; margin-bottom:0.2rem;">Last Job Search:</strong>
            {% if selected_company.last_job_search_date %}
              <span style="background:#d1fae5; color:#065f46; border-radius:4px; padding:0.25rem 0.6rem; font-size:0.95rem; display:inline-block;">{{ selected_company.last_job_search_date|date:"Y-m-d H:i" }}</span>
              <span style="font-size:0.8rem; color:#6b7280; margin-left:0.3rem;">({{ selected_company.last_job_search_date|timesince }} ago)</span>
            {% else %}
              <span style="background:#f3f4f6; color:#6b7280; border-radius:4px; padding:0.25rem 0.6rem; font-size:0.95rem; font-style:italic; display:inline-block;">Never searched</span>
            {% endif %}
          </div>
          {% if days_since_last_message is not None %}
          <div>
            <strong style="display:block; font-size:0.85rem; color:#6b7280; margin-bottom:0.2rem;">Days since last message:</strong>
            <span style="background:#fef3c7; color:#92400e; border-radius:4px; padding:0.25rem 0.6rem; font-size:0.95rem; display:inline-block;">{{ days_since_last_message }}</span>
            {% if ghosted_days_threshold and days_since_last_message >= ghosted_days_threshold and latest_label != 'rejection' and latest_label != 'rejected' %}
              <span title="Consider marking as ghosted if appropriate" style="margin-left:0.4rem; color:#b45309; font-size:0.9rem;">(Consider ghosted)</span>
            {% endif %}
          </div>
          {% endif %}
        </div>
        <!-- Mark as Searched Checkbox -->
        <form method="post" style="margin-top:1rem; padding:0.75rem; background:#f0fdf4; border:1px solid #86efac; border-radius:6px;">
          {% csrf_token %}
          <input type="hidden" name="company" value="{{ selected_company.id }}" />
          <label style="display:flex; align-items:center; cursor:pointer; font-size:0.95rem; color:#166534;">
            <input type="checkbox" name="mark_searched" value="1" style="width:auto; margin-right:0.5rem; cursor:pointer;" onchange="this.form.submit()">
            <strong>üîç I manually searched this company's website for jobs today</strong>
          </label>
        </form>
      </div>
      <div style="display: flex; gap: 2rem; align-items: flex-start;">
        <div style="flex: 1;">
          <form method="post" class="edit-form">
          {% csrf_token %}
          <input type="hidden" name="company" value="{{ selected_company.id }}" />
          <label for="id_name">Company Name</label>
          {{ form.name }}
          <label for="id_focus_area">Focus Area</label>
          {{ form.focus_area }}
          <small style="color:#6b7280; display:block; margin-top:0.25rem; margin-bottom:0.5rem;">Business focus (e.g., Software as a Service, Mining, Network Security)</small>
          <label for="id_domain">Domain Name</label>
          {{ form.domain }}
          <label for="id_ats">ATS Domain (if any)</label>
          {{ form.ats }}
          <label for="id_homepage">Homepage</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            {{ form.homepage }}
            <button type="button" onclick="populateCompanyInfo()" style="background:#059669; color:white; font-weight:600; border-radius:6px; padding:0.6rem 1rem; border:none; cursor:pointer; white-space:nowrap;" title="Scrape company info from homepage">üîç Populate</button>
          </div>
          <small style="color:#6b7280; display:block; margin-top:0.25rem; margin-bottom:0.5rem;">Enter homepage URL and click Populate to auto-fill company details</small>
          <div id="populate_status" style="margin-top:0.5rem; display:none;"></div>
          <label for="id_career_url">Career/Jobs URL</label>
          {{ form.career_url }}
          <label for="id_alias">Alias (Optional)</label>
          {{ form.alias }}
          <small style="color:#6b7280; display:block; margin-top:0.25rem; margin-bottom:0.5rem;">Alternative name(s) or abbreviation(s). Separate multiple aliases with commas (e.g., 'AFS, Accenture Fed')</small>
          <label for="id_contact_name">Contact Name</label>
          {{ form.contact_name }}
          <label for="id_contact_email">Contact Email</label>
          {{ form.contact_email }}
          <label for="id_status">Status</label>
          {{ form.status }}
          <button type="button" onclick="saveCompanyChanges()" style="background:#2563eb; color:white; font-weight:600; border-radius:6px; padding:0.6rem 1.2rem; border:none; cursor:pointer; margin-top:1rem;">Save Changes</button>
          <div id="save_status" style="margin-top:0.5rem; display:none;"></div>
        </form>
        </div>
        <div style="flex: 1; display: flex; flex-direction: column; gap: 1rem;">
          <!-- DEBUG: About to render Company Data Preview for company={{ selected_company.name }}, message_count={{ message_count }}, application_threads count={{ application_threads|length }} -->
          <div style="background: #f3f4f6; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
            <h2 style="margin-top:0; color:#1e40af; font-size:1.1rem;">Company Data Preview</h2>
            <div style="margin-bottom:1rem;"><strong>Company:</strong> {{ selected_company.name }}</div>
            <div style="margin-bottom:1rem;"><strong>Messages in database:</strong> {{ message_count }} {% if message_count == 0 %}<span style="color:#9ca3af;">(No non-noise messages found)</span>{% endif %}</div>
            <div style="margin-bottom:1rem;">
              <strong>üìã Applications:</strong>
              <ul style="margin:0.5rem 0 0 0; padding-left:1.2rem; font-size:0.97rem; list-style:none;">
                {% for thread in application_threads %}
                  <li style="margin-bottom:0.5rem;">
                    <div style="display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap;">
                      <span style="color:#6b7280; white-space:nowrap;">{{ thread.sent_date|date:"Y-m-d" }}</span>
                      {# All entries in application_threads are job applications (have a job_application message) #}
                      {# Show offer badge if offer received, cancelled/withdrew if applicable, otherwise show APPLICATION #}
                      {% if thread.ml_label == "offer" or thread.status == "offer" or thread.offer_date %}
                        <span style="background:#d1fae5; color:#065f46; border-radius:3px; padding:0.15rem 0.4rem; font-size:0.8rem; font-weight:600; white-space:nowrap;">üéâ OFFER</span>
                      {% elif thread.cancelled %}
                        <span style="background:#fef3c7; color:#92400e; border-radius:3px; padding:0.15rem 0.4rem; font-size:0.8rem; font-weight:600; white-space:nowrap;">üö´ CANCELLED</span>
                      {% elif thread.withdrew %}
                        <span style="background:#e0e7ff; color:#3730a3; border-radius:3px; padding:0.15rem 0.4rem; font-size:0.8rem; font-weight:600; white-space:nowrap;">üö∂ WITHDREW</span>
                      {% elif thread.status == "rejected" or thread.rejection_date %}
                        <span style="background:#fee2e2; color:#991b1b; border-radius:3px; padding:0.15rem 0.4rem; font-size:0.8rem; font-weight:600; white-space:nowrap;">REJECTED</span>
                      {% else %}
                        <span style="background:#dcfce7; color:#166534; border-radius:3px; padding:0.15rem 0.4rem; font-size:0.8rem; font-weight:600; white-space:nowrap;">APPLICATION</span>
                      {% endif %}
                      <span style="color:#374151; flex:1;">{{ thread.job_title|default:"(No job title)" }}</span>
                      {% if thread.prescreen_date %}
                        <span style="color:#92400e; font-size:0.85rem; white-space:nowrap;">üìû {{ thread.prescreen_date|date:"M d" }}</span>
                      {% endif %}
                      {% if thread.interview_date %}
                        <span style="color:#1e40af; font-size:0.85rem; white-space:nowrap;">üóìÔ∏è {{ thread.interview_date|date:"M d" }}</span>
                      {% endif %}
                      {% if thread.rejection_date %}
                        <span style="color:#991b1b; font-size:0.85rem; white-space:nowrap;">{% if thread.cancelled %}üö´{% elif thread.withdrew %}üö∂{% else %}‚ùå{% endif %} {{ thread.rejection_date|date:"M d" }}</span>
                      {% endif %}
                      {% if thread.offer_date %}
                        <span style="color:#065f46; font-size:0.85rem; white-space:nowrap;">üéâ {{ thread.offer_date|date:"M d" }}</span>
                      {% endif %}
                    </div>
                  </li>
                {% empty %}
                  <li style="color:#9ca3af;">No applications found for this company.</li>
                {% endfor %}
              </ul>
            </div>
            <div style="max-height: 240px; overflow-y: auto;">
              <strong>All Email Dates, Labels &amp; Subjects:</strong>
              <ul style="margin:0.5rem 0 0 0; padding-left:1.2rem; font-size:0.97rem; list-style:none;">
                {% for mid, ts, subj, label in message_info_list %}
                  <li style="margin-bottom:0.5rem;">
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                      <span style="color:#6b7280; white-space:nowrap;">{{ ts|date:"Y-m-d H:i" }}</span>
                      <span style="background:#e0e7ff; color:#3730a3; border-radius:3px; padding:0.15rem 0.4rem; font-size:0.8rem; font-weight:600; white-space:nowrap;">{{ label|default:"N/A" }}</span>
                      <a href="{% url 'label_messages' %}?reviewed=all&label=all&sort=date&order=desc&focus={{ mid }}" style="color:#2563eb; text-decoration:none; flex:1;">
                        {{ subj|truncatechars:70 }}
                      </a>
                    </div>
                  </li>
                {% empty %}
                  <li style="color:#9ca3af;">No messages found for this company.</li>
                {% endfor %}
              </ul>
            </div>
          </div>
          <!-- Notes Section (expandable) -->
          <details open style="background: #fefce8; border-radius: 8px; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
            <summary style="cursor: pointer; padding: 1rem 1.5rem; font-weight: 600; color: #854d0e; font-size: 1rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
              <span style="transition: transform 0.2s;">‚ñ∂</span> Notes
            </summary>
            <div style="padding: 0 1.5rem 1.5rem 1.5rem;">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="company" value="{{ selected_company.id }}" />
                <input type="hidden" name="action" value="save_notes" />
                <textarea name="notes" rows="6" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; resize: vertical; font-family: inherit; box-sizing: border-box;">{{ selected_company.notes|default:'' }}</textarea>
                <button type="submit" style="background: #ca8a04; color: white; font-weight: 600; border-radius: 6px; padding: 0.5rem 1rem; border: none; cursor: pointer; margin-top: 0.75rem;">Save Notes</button>
              </form>
            </div>
          </details>
          <style>
            details[open] summary span:first-child { transform: rotate(90deg); }
          </style>
          
          <!-- Documents Section (expandable) -->
          <details style="background: #e0e7ff; border-radius: 8px; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
            <summary style="cursor: pointer; padding: 1rem 1.5rem; font-weight: 600; color: #3730a3; font-size: 1rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
              <span style="transition: transform 0.2s;">‚ñ∂</span> üìé Documents{% if company_documents %} ({{ company_documents|length }}){% endif %}
            </summary>
            <div style="padding: 0 1.5rem 1.5rem 1.5rem;">
              <!-- Existing Documents -->
              {% if company_documents %}
              <div style="margin-bottom: 1rem;">
                <ul style="list-style: none; padding: 0; margin: 0;">
                  {% for doc in company_documents %}
                  <li style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #c7d2fe;">
                    <span style="font-size: 1.25rem;">
                      {% if doc.file_extension == '.pdf' %}üìÑ{% elif doc.file_extension == '.xlsx' %}üìä{% elif doc.file_extension == '.docx' %}üìù{% else %}üìÉ{% endif %}
                    </span>
                    <div style="flex: 1;">
                      <a href="{{ doc.file.url }}" target="_blank" style="color: #3730a3; text-decoration: none; font-weight: 500;">{{ doc.filename }}</a>
                      {% if doc.description %}
                      <div style="font-size: 0.85rem; color: #6b7280;">{{ doc.description }}</div>
                      {% endif %}
                      <div style="font-size: 0.8rem; color: #9ca3af;">{{ doc.file_size_display }} ‚Ä¢ {{ doc.uploaded_at|date:"M d, Y" }}</div>
                    </div>
                    <form method="post" action="{% url 'delete_company_document' doc.id %}" style="margin: 0;" onsubmit="return confirm('Delete this document?');">
                      {% csrf_token %}
                      <button type="submit" style="background: #fee2e2; color: #991b1b; border: none; border-radius: 4px; padding: 0.35rem 0.6rem; cursor: pointer; font-size: 0.85rem;" title="Delete document">üóëÔ∏è</button>
                    </form>
                  </li>
                  {% endfor %}
                </ul>
              </div>
              {% else %}
              <p style="color: #6b7280; font-size: 0.95rem; margin-bottom: 1rem;">No documents uploaded yet.</p>
              {% endif %}
              
              <!-- Upload Form -->
              <form method="post" action="{% url 'upload_company_document' selected_company.id %}" enctype="multipart/form-data" style="background: white; padding: 1rem; border-radius: 6px; border: 1px solid #c7d2fe;">
                {% csrf_token %}
                <div style="margin-bottom: 0.75rem;">
                  <label for="document" style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Upload Document:</label>
                  <input type="file" name="document" id="document" accept=".pdf,.txt,.xlsx,.docx" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;" />
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">PDF, TXT, XLSX, DOCX only. Max 5MB.</small>
                </div>
                <div style="margin-bottom: 0.75rem;">
                  <label for="description" style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Description (optional):</label>
                  <input type="text" name="description" id="description" placeholder="e.g., Offer Letter, Contract, NDA" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box;" />
                </div>
                <button type="submit" style="background: #4f46e5; color: white; font-weight: 600; border-radius: 6px; padding: 0.5rem 1rem; border: none; cursor: pointer;">üì§ Upload</button>
              </form>
            </div>
          </details>
          
          <!-- Application Details Section -->
          {% if application_threads %}
          <details style="background: #dbeafe; border-radius: 8px; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
            <summary style="cursor: pointer; padding: 1rem 1.5rem; font-weight: 600; color: #1e40af; font-size: 1rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
              <span style="transition: transform 0.2s;">‚ñ∂</span> Application Details ({{ application_threads|length }} record{{ application_threads|length|pluralize }})
            </summary>
            <div style="padding: 0 1.5rem 1.5rem 1.5rem;">
              <form method="post" style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                {% csrf_token %}
                <input type="hidden" name="company" value="{{ selected_company.id }}" />
                <input type="hidden" name="action" value="save_application_details" />
                <input type="hidden" name="thread_id" id="selected_thread_id" value="{% if application_threads %}{{ application_threads.0.thread_id }}{% endif %}" />
                
                {% if application_threads|length > 1 %}
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 6px;">
                  <label for="application_selector" style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">üìã Select Application to Edit:</label>
                  <select id="application_selector" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; background: white;">
                    {% for thread in application_threads %}
                    <option value="{{ thread.thread_id }}" 
                            data-jobtitle="{{ thread.job_title|default:'' }}"
                            data-sentdate="{{ thread.sent_date|date:'Y-m-d'|default:'' }}"
                            data-prescreen="{{ thread.prescreen_date|date:'Y-m-d'|default:'' }}"
                            data-interview="{{ thread.interview_date|date:'Y-m-d'|default:'' }}"
                            data-rejection="{{ thread.rejection_date|date:'Y-m-d'|default:'' }}"
                            data-offer="{{ thread.offer_date|date:'Y-m-d'|default:'' }}"
                            data-url="{{ thread.application_url|default:'' }}"
                            data-text="{{ thread.application_text|default:'' }}">
                      {% if thread.job_title %}{{ thread.job_title }}{% else %}Application #{{ forloop.counter }}{% endif %} - {{ thread.sent_date|date:'M d, Y' }} ({% if thread.ml_label == 'job_application' %}application{% elif thread.ml_label == 'prescreen' %}prescreen{% elif thread.ml_label == 'interview_invite' %}interview{% else %}{{ thread.ml_label|default:'application' }}{% endif %})
                    </option>
                    {% endfor %}
                  </select>
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">This company has {{ application_threads|length }} application records</small>
                </div>
                {% endif %}
                
                <div style="margin-bottom: 1rem;">                  <label for="id_job_title" style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">üíº Job Title:</label>
                  <input type="text" name="job_title" id="id_job_title" value="{% if application_threads %}{{ application_threads.0.job_title|default:'' }}{% endif %}" placeholder="e.g., Senior Software Engineer, Product Manager" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box;" />
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">Title of the position you applied for</small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                  <label for="id_sent_date" style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">üìÖ Application Date</label>
                  <input type="date" name="sent_date" id="id_sent_date" value="{% if application_threads %}{{ application_threads.0.sent_date|date:'Y-m-d'|default:'' }}{% endif %}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;" />
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">Date you submitted the application</small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">                  <label for="id_prescreen_date" style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">üìû Prescreen Date</label>
                  <input type="date" name="prescreen_date" id="id_prescreen_date" value="{% if application_threads %}{{ application_threads.0.prescreen_date|date:'Y-m-d'|default:'' }}{% endif %}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;" />
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">Date of prescreen phone call</small>
                </div>
                
                <div style="margin-bottom: 1rem;">
                  <label for="id_interview_date" style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">üóìÔ∏è Interview Date</label>
                  <input type="date" name="interview_date" id="id_interview_date" value="{% if application_threads %}{{ application_threads.0.interview_date|date:'Y-m-d'|default:'' }}{% endif %}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;" />
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">Date of scheduled interview</small>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                  <label for="id_rejection_date" style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">‚ùå Rejection Date</label>
                  <input type="date" name="rejection_date" id="id_rejection_date" value="{% if application_threads %}{{ application_threads.0.rejection_date|date:'Y-m-d'|default:'' }}{% endif %}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;" />
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">Date rejection was received (or date of cancellation/withdrawal)</small>
                  
                  <!-- Cancelled and Withdrew checkboxes -->
                  <div style="display: flex; gap: 1.5rem; margin-top: 0.75rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                      <input type="checkbox" name="cancelled" id="id_cancelled" {% if application_threads and application_threads.0.cancelled %}checked{% endif %} style="width: 1rem; height: 1rem; cursor: pointer;" />
                      <span style="color: #92400e;">üö´ Cancelled</span>
                      <small style="color: #78716c;">(job was cancelled)</small>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                      <input type="checkbox" name="withdrew" id="id_withdrew" {% if application_threads and application_threads.0.withdrew %}checked{% endif %} style="width: 1rem; height: 1rem; cursor: pointer;" />
                      <span style="color: #92400e;">üö∂ Withdrew</span>
                      <small style="color: #78716c;">(I withdrew)</small>
                    </label>
                  </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                  <label for="id_offer_date" style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">üéâ Offer Date</label>
                  <input type="date" name="offer_date" id="id_offer_date" value="{% if application_threads %}{{ application_threads.0.offer_date|date:'Y-m-d'|default:'' }}{% endif %}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;" />
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">Date offer was received</small>
                </div>
                
                <div style="margin-bottom: 1rem;">
                  <label for="id_application_url" style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">üîó Application URL</label>
                  <div style="display: flex; gap: 0.5rem; align-items: start;">
                    <input type="url" name="application_url" id="id_application_url" value="{% if application_threads %}{{ application_threads.0.application_url|default:'' }}{% endif %}" placeholder="https://company.com/job/12345" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;" />
                    <button type="button" id="scrape_button" onclick="manualScrapeJobPosting()" style="background: #10b981; color: white; font-weight: 600; border-radius: 6px; padding: 0.5rem 1rem; border: none; cursor: pointer; white-space: nowrap; font-size: 0.9rem; transition: background 0.2s;">
                      üîÑ Scrape Text
                    </button>
                  </div>
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">Enter URL and click "Scrape Text" to extract job posting content</small>
                </div>
                
                <div style="margin-bottom: 1rem;">
                  <label for="id_application_text" style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">üìù Application Text</label>
                  <textarea name="application_text" id="id_application_text" rows="4" placeholder="Cover letter or notes about your application" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; resize: vertical; font-family: inherit; box-sizing: border-box;">{% if application_threads %}{{ application_threads.0.application_text|default:'' }}{% endif %}</textarea>
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">Cover letter or application notes (max 10,000 characters)</small>
                </div>
                
                <button type="submit" style="background: #2563eb; color: white; font-weight: 600; border-radius: 6px; padding: 0.5rem 1rem; border: none; cursor: pointer;">Save Application Details</button>
              </form>
            </div>
          </details>
          {% else %}
          <div style="background: #f3f4f6; border-radius: 8px; padding: 1.5rem; color: #6b7280; font-style: italic;">
            üì≠ No application records found. Create one by sending a job application message.
          </div>
          {% endif %}{# end application_threads check #}
        </div>
      </div>
      {% endif %}{# end creating_new_company else #}
      {% else %}
        <div style="color:#9ca3af; margin-top:2rem;">Select a company to edit its details.</div>
      {% endif %}
    </div>
    <!-- End company edit form content -->

    <script>
      // Application selector handler - load selected application data
      (function() {
        const selector = document.getElementById('application_selector');
        if (!selector) return;
        
        selector.addEventListener('change', function() {
          const selected = this.options[this.selectedIndex];
          
          // Update hidden thread_id input
          document.getElementById('selected_thread_id').value = selected.value;
          
          // Update form fields with selected application data
          document.getElementById('id_job_title').value = selected.dataset.jobtitle || '';
          document.getElementById('id_sent_date').value = selected.dataset.sentdate || '';
          document.getElementById('id_prescreen_date').value = selected.dataset.prescreen || '';
          document.getElementById('id_interview_date').value = selected.dataset.interview || '';
          document.getElementById('id_rejection_date').value = selected.dataset.rejection || '';
          document.getElementById('id_offer_date').value = selected.dataset.offer || '';
          document.getElementById('id_application_url').value = selected.dataset.url || '';
          document.getElementById('id_application_text').value = selected.dataset.text || '';
        });
      })();
    </script>

    <script>
      // Manual scrape job posting URL button handler
      function manualScrapeJobPosting() {
        const urlInput = document.getElementById('id_application_url');
        const textArea = document.getElementById('id_application_text');
        const scrapeButton = document.getElementById('scrape_button');
        
        if (!urlInput || !textArea || !scrapeButton) return;
        
        const url = urlInput.value.trim();
        
        // Validate URL
        if (!url) {
          showNotification('‚ö†Ô∏è Please enter a URL first', '#ef4444');
          return;
        }
        
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          showNotification('‚ö†Ô∏è URL must start with http:// or https://', '#ef4444');
          return;
        }
        
        // Show loading state
        const originalButtonText = scrapeButton.innerHTML;
        scrapeButton.innerHTML = '‚è≥ Scraping...';
        scrapeButton.disabled = true;
        scrapeButton.style.background = '#6b7280';
        
        const originalPlaceholder = textArea.placeholder;
        textArea.placeholder = 'üîÑ Scraping job posting...';
        textArea.disabled = true;
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Make AJAX request to scrape endpoint
        fetch('/api/scrape_job_posting/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken,
          },
          body: new URLSearchParams({
            'url': url
          })
        })
        .then(response => response.json())
        .then(data => {
          console.log('Scrape response:', data);
          if (data.success && data.content) {
            // Populate textarea (overwrite existing content)
            textArea.value = data.content;
            showNotification('‚úÖ Job posting scraped successfully! (' + data.content.length + ' characters)', '#10b981');
          } else if (data.error) {
            // Show error notification
            showNotification('‚ö†Ô∏è ' + data.error, '#ef4444');
          } else {
            console.error('Unexpected response format:', data);
            showNotification('‚ùå Failed to scrape job posting (unexpected response)', '#ef4444');
          }
        })
        .catch(error => {
          console.error('Scraping error:', error);
          showNotification('‚ùå Failed to scrape job posting: ' + error.message, '#ef4444');
        })
        .finally(() => {
          // Restore button and textarea state
          scrapeButton.innerHTML = originalButtonText;
          scrapeButton.disabled = false;
          scrapeButton.style.background = '#10b981';
          textArea.placeholder = originalPlaceholder;
          textArea.disabled = false;
        });
      }
      
      function showNotification(message, bgColor) {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${bgColor}; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 0.9rem;`;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 4000);
      }
      
      // AJAX function to populate company info without page refresh
      function populateCompanyInfo() {
        const homepageInput = document.getElementById('id_homepage');
        const homepageUrl = homepageInput.value.trim();
        const statusDiv = document.getElementById('populate_status');
        
        if (!homepageUrl) {
          statusDiv.style.display = 'block';
          statusDiv.innerHTML = '<span style="color:#b91c1c; font-weight:600;">‚ùå Please enter a homepage URL first.</span>';
          return;
        }
        
        // Show loading state
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<span style="color:#2563eb; font-weight:600;">üîÑ Populating company info...</span>';
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const companyId = {{ selected_company.id|default:"null" }};
        
        // Make AJAX request
        fetch(window.location.pathname, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: new URLSearchParams({
            'csrfmiddlewaretoken': csrfToken,
            'action': 'populate_from_homepage',
            'company': companyId || '',
            'homepage': homepageUrl
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update form fields with scraped data
            if (data.name) document.getElementById('id_name').value = data.name;
            if (data.domain) document.getElementById('id_domain').value = data.domain;
            if (data.career_url) document.getElementById('id_career_url').value = data.career_url;
            if (data.notes) {
              const notesTextarea = document.querySelector('[name="notes"]');
              if (notesTextarea) {
                const currentNotes = notesTextarea.value.trim();
                notesTextarea.value = currentNotes ? currentNotes + '\\n\\n' + data.notes : data.notes;
              }
            }
            
            statusDiv.innerHTML = '<span style="color:#059669; font-weight:600;">‚úÖ ' + data.message + '</span>';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
          } else {
            // Update notes textarea with error message
            if (data.notes) {
              const notesTextarea = document.querySelector('[name="notes"]');
              if (notesTextarea) {
                const currentNotes = notesTextarea.value.trim();
                notesTextarea.value = currentNotes ? currentNotes + '\\n\\n' + data.notes : data.notes;
              }
            }
            statusDiv.innerHTML = '<span style="color:#b91c1c; font-weight:600;">‚ùå ' + data.message + '</span>';
          }
        })
        .catch(error => {
          statusDiv.innerHTML = '<span style="color:#b91c1c; font-weight:600;">‚ùå Network error: ' + error.message + '</span>';
        });
      }
      
      // AJAX function to save company changes without page refresh
      function saveCompanyChanges() {
        const form = document.querySelector('.edit-form');
        const statusDiv = document.getElementById('save_status');
        const formData = new FormData(form);
        
        // Show loading state
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<span style="color:#2563eb; font-weight:600;">üíæ Saving changes...</span>';
        
        // Make AJAX request
        fetch(window.location.pathname, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            statusDiv.innerHTML = '<span style="color:#059669; font-weight:600;">‚úÖ ' + data.message + '</span>';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
          } else {
            statusDiv.innerHTML = '<span style="color:#b91c1c; font-weight:600;">‚ùå ' + data.message + '</span>';
          }
        })
        .catch(error => {
          statusDiv.innerHTML = '<span style="color:#b91c1c; font-weight:600;">‚ùå Network error: ' + error.message + '</span>';
        });
      }
    </script>
    </div>
    <!-- End scrollable content -->
  </div>
  <!-- End flex container -->
{% endblock %}
