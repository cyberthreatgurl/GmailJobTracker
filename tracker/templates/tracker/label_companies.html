{% extends "base.html" %}
{% block title %}Label Companies - GmailJobTracker{% endblock %}
{% block extra_head %}
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 0; background: #f9fafb; color: #333; }
    .dashboard-layout { display: flex; gap: 0.5rem; margin: 0; }
    .sidebar { flex: 0 0 220px; max-width: 240px; }
    .main-content { flex: 1; padding: 2rem 2rem 2rem 0.5rem; }
    h1 { color: #1f2937; margin-bottom: 1.5rem; font-size: 1.5rem; }
    .company-select { margin-bottom: 2rem; display: flex; align-items: center; gap: 1rem; }
    select { padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid #d1d5db; font-size: 1rem; min-width: 220px; }
    .edit-form { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.07); padding: 1.5rem 2rem; max-width: 500px; }
    .edit-form label { font-weight: 500; display: block; margin-top: 1rem; }
    .edit-form input, .edit-form select { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db; font-size: 1rem; margin-top: 0.3rem; }
    .edit-form button { background: #2563eb; color: white; font-weight: 600; padding: 0.6rem 1.2rem; border: none; border-radius: 6px; cursor: pointer; margin-top: 1.5rem; font-size: 1rem; }
    .edit-form button:hover { background: #1e40af; }
    .label-info { margin-top: 1.5rem; font-size: 0.95rem; color: #2563eb; }
    .messages { margin-bottom: 1.5rem; }
    .message { padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .message.success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
    .message.error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
    .message.info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
  </style>
{% endblock %}
{% block content %}
    <div class="main-content">
      <h1>Label Companies</h1>
        <div style="margin: 0 0 1rem 0;">
          <button type="button" onclick="if (window.history.length > 1) { window.history.back(); } else { window.location.href='/' }" 
                  style="background:#6b7280; color:white; font-weight:600; border-radius:6px; padding:0.5rem 1rem; border:none; cursor:pointer;">
            Back
          </button>
          <script>
            // Ensure Enter key doesn't trigger unintended navigation
            document.addEventListener('keydown', function(e){
              const active = document.activeElement;
              if (e.key === 'Enter' && active && active.tagName === 'BUTTON' && active.getAttribute('onclick')) {
                e.preventDefault();
                active.click();
              }
            });
          </script>
        </div>
      
      {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %}
      
      <form method="get" class="company-select">
        <label for="company">Select Company:</label>
        <select name="company" id="company" onchange="this.form.submit()">
          <option value="">-- Choose a company --</option>
          {% for c in company_list %}
            <option value="{{ c.id }}" {% if selected_company and c.id == selected_company.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </form>
      {% if selected_company %}
      <div style="display: flex; gap: 2rem; align-items: flex-start;">
        <div style="flex: 1;">
          <form method="post" class="edit-form">
          {% csrf_token %}
          <label for="id_name">Company Name</label>
          {{ form.name }}
          <label for="id_domain">Domain Name</label>
          {{ form.domain }}
          <label for="id_ats">ATS Domain (if any)</label>
          {{ form.ats }}
          <label for="id_homepage">Homepage</label>
          {{ form.homepage }}
          <label for="id_contact_name">Contact Name</label>
          {{ form.contact_name }}
          <label for="id_contact_email">Contact Email</label>
          {{ form.contact_email }}
          <label for="id_status">Status</label>
          {{ form.status }}
          <button type="submit">Save Changes</button>
        </form>
        <form method="get" action="{% url 'delete_company' selected_company.id %}" style="margin-top:1.5rem;">
          <button type="submit" style="background:#b91c1c; color:white; font-weight:600; border-radius:6px; padding:0.6rem 1.2rem; border:none; cursor:pointer;">Delete Company</button>
        </form>
        <div class="label-info">
          <strong>Latest Label from Messages:</strong>
          <span style="background:#e0e7ff; color:#3730a3; border-radius:4px; padding:0.2rem 0.5rem; font-size:0.95rem;">{{ latest_label|default:"N/A" }}</span>
        </div>
        </div>
        <div style="flex: 1; background: #f3f4f6; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
          <h2 style="margin-top:0; color:#1e40af; font-size:1.1rem;">Company Data Preview</h2>
          <div style="margin-bottom:1rem;"><strong>Messages in database:</strong> {{ message_count }}</div>
          <div style="max-height: 320px; overflow-y: auto;">
            <strong>All Email Dates &amp; Subjects to be Deleted:</strong>
            <ul style="margin:0.5rem 0 0 0; padding-left:1.2rem; font-size:0.97rem;">
              {% for ts, subj in message_info_list %}
                <li><span style="color:#6b7280;">{{ ts|date:"Y-m-d H:i" }}</span> â€” <span style="color:#111827;">{{ subj|truncatechars:80 }}</span></li>
              {% empty %}
                <li style="color:#9ca3af;">No messages found for this company.</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      {% else %}
        <div style="color:#9ca3af; margin-top:2rem;">Select a company to edit its details.</div>
      {% endif %}
    </div>
{% endblock %}
