{% extends "base.html" %}
{% block title %}Label Companies - GmailJobTracker{% endblock %}
{% block extra_head %}
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 0; background: #f9fafb; color: #333; }
    .dashboard-layout { display: flex; gap: 0.5rem; margin: 0; }
    .sidebar { flex: 0 0 220px; max-width: 240px; }
    .main-content { flex: 1; padding: 2rem 2rem 2rem 0.5rem; }
    h1 { color: #1f2937; margin-bottom: 1.5rem; font-size: 1.5rem; }
    .company-select { margin-bottom: 2rem; display: flex; align-items: center; gap: 1rem; }
    select { padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid #d1d5db; font-size: 1rem; min-width: 220px; }
    .edit-form { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.07); padding: 1.5rem 2rem; max-width: 500px; }
    .edit-form label { font-weight: 500; display: block; margin-top: 1rem; }
    .edit-form input, .edit-form select { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db; font-size: 1rem; margin-top: 0.3rem; }
    .edit-form button { background: #2563eb; color: white; font-weight: 600; padding: 0.6rem 1.2rem; border: none; border-radius: 6px; cursor: pointer; margin-top: 1.5rem; font-size: 1rem; }
    .edit-form button:hover { background: #1e40af; }
    .label-info { margin-top: 1.5rem; font-size: 0.95rem; color: #2563eb; }
    .messages { margin-bottom: 1.5rem; }
    .message { padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .message.success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
    .message.error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
    .message.info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
  </style>
{% endblock %}
{% block content %}
    <div class="main-content">
      <h1>Label Companies</h1>
        <div style="margin: 0 0 1rem 0;">
          <button type="button" onclick="if (window.history.length > 1) { window.history.back(); } else { window.location.href='/' }" 
                  style="background:#6b7280; color:white; font-weight:600; border-radius:6px; padding:0.5rem 1rem; border:none; cursor:pointer;">
            Back
          </button>
          <script>
            // Ensure Enter key doesn't trigger unintended navigation
            document.addEventListener('keydown', function(e){
              const active = document.activeElement;
              if (e.key === 'Enter' && active && active.tagName === 'BUTTON' && active.getAttribute('onclick')) {
                e.preventDefault();
                active.click();
              }
            });
          </script>
        </div>
      
      {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %}
      
      <form method="get" class="company-select">
        <label for="company">Select Company:</label>
        <select name="company" id="company" onchange="this.form.submit()">
          <option value="">-- Choose a company --</option>
          {% for c in company_list %}
            <option value="{{ c.id }}" {% if selected_company and c.id == selected_company.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </form>

      <!-- Merge Companies Section -->
      <div style="background:#fef9c3; border:1px solid #fde047; border-radius:8px; padding:1.25rem; margin-bottom:1.5rem;">
        <h3 style="margin:0 0 0.75rem 0; color:#854d0e; font-size:1rem; display:flex; justify-content:space-between; align-items:center;">
          <span>ðŸ”— Merge Duplicate Companies</span>
          <button type="button" onclick="toggleMergeSection()" id="toggleMergeBtn" style="background:#ca8a04; color:white; font-size:0.85rem; padding:0.35rem 0.75rem; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Show</button>
        </h3>
        <div id="mergeSection" style="display:none;">
          <p style="margin:0.5rem 0 1rem 0; font-size:0.9rem; color:#713f12;">Select 2 or more companies to merge. You'll choose which name to keep on the next page.</p>
          <div style="max-height:200px; overflow-y:auto; border:1px solid #fde047; border-radius:4px; background:white; padding:0.5rem;">
            {% for c in company_list %}
            <label style="display:block; padding:0.4rem; cursor:pointer; border-radius:3px;" onmouseover="this.style.background='#fef9c3'" onmouseout="this.style.background='white'">
              <input type="checkbox" class="merge-checkbox" value="{{ c.id }}" style="margin-right:0.5rem;" />
              <span style="font-size:0.95rem; color:#1f2937;">{{ c.name }}</span>
            </label>
            {% endfor %}
          </div>
          <button type="button" onclick="mergeSelectedCompanies()" style="background:#2563eb; color:white; font-weight:600; padding:0.5rem 1rem; border:none; border-radius:6px; cursor:pointer; margin-top:1rem; font-size:0.9rem;">Merge Selected Companies</button>
          <span id="mergeError" style="color:#b91c1c; font-size:0.85rem; margin-left:1rem; display:none;"></span>
        </div>
      </div>

      <script>
        function toggleMergeSection() {
          const section = document.getElementById('mergeSection');
          const btn = document.getElementById('toggleMergeBtn');
          if (section.style.display === 'none') {
            section.style.display = 'block';
            btn.textContent = 'Hide';
          } else {
            section.style.display = 'none';
            btn.textContent = 'Show';
          }
        }

        function mergeSelectedCompanies() {
          const checkboxes = document.querySelectorAll('.merge-checkbox:checked');
          const errorSpan = document.getElementById('mergeError');
          
          if (checkboxes.length < 2) {
            errorSpan.textContent = 'Please select at least 2 companies to merge.';
            errorSpan.style.display = 'inline';
            return;
          }
          
          const companyIds = Array.from(checkboxes).map(cb => cb.value);
          const queryString = companyIds.map(id => `company_ids=${id}`).join('&');
          window.location.href = `{% url 'merge_companies' %}?${queryString}`;
        }
      </script>

      {% if selected_company %}
      <!-- Company Metrics and Quick Actions at the top -->
      <div style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:1rem 1.5rem; margin-bottom:1.5rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
          <h2 style="margin:0; color:#1e40af; font-size:1.1rem;">Company Metrics</h2>
          <div style="display:flex; gap:0.5rem;">
            {# Save is handled by the main edit form below; no separate POST here #}
            {% if latest_label != 'rejection' and latest_label != 'rejected' %}
            <form method="post" style="margin:0;">
              {% csrf_token %}
              <input type="hidden" name="company" value="{{ selected_company.id }}" />
              <button type="submit" name="action" value="mark_ghosted" style="background:#92400e; color:white; font-weight:600; border-radius:6px; padding:0.45rem 1rem; border:none; cursor:pointer;">Mark as Ghosted</button>
            </form>
            {% else %}
              <button type="button" title="Cannot ghost: latest message is a rejection" style="background:#d1d5db; color:#6b7280; font-weight:600; border-radius:6px; padding:0.45rem 1rem; border:none; cursor:not-allowed;">Mark as Ghosted</button>
            {% endif %}
            <form method="get" action="{% url 'delete_company' selected_company.id %}" style="margin:0;">
              <button type="submit" style="background:#b91c1c; color:white; font-weight:600; border-radius:6px; padding:0.45rem 1rem; border:none; cursor:pointer;">Delete Company</button>
            </form>
          </div>
        </div>
        <div style="display:flex; flex-wrap:wrap; gap:1.5rem;">
          <div>
            <strong style="display:block; font-size:0.85rem; color:#6b7280; margin-bottom:0.2rem;">Company Status:</strong>
            <span style="background:#f3f4f6; color:#111827; border-radius:4px; padding:0.25rem 0.6rem; font-size:0.95rem; border:1px solid #e5e7eb; display:inline-block;">{{ selected_company.status|default:"application" }}</span>
          </div>
          <div>
            <strong style="display:block; font-size:0.85rem; color:#6b7280; margin-bottom:0.2rem;">Latest Label from Messages:</strong>
            <span style="background:#e0e7ff; color:#3730a3; border-radius:4px; padding:0.25rem 0.6rem; font-size:0.95rem; display:inline-block;">{{ latest_label|default:"N/A" }}</span>
          </div>
          {% if days_since_last_message is not None %}
          <div>
            <strong style="display:block; font-size:0.85rem; color:#6b7280; margin-bottom:0.2rem;">Days since last message:</strong>
            <span style="background:#fef3c7; color:#92400e; border-radius:4px; padding:0.25rem 0.6rem; font-size:0.95rem; display:inline-block;">{{ days_since_last_message }}</span>
            {% if ghosted_days_threshold and days_since_last_message >= ghosted_days_threshold and latest_label != 'rejection' and latest_label != 'rejected' %}
              <span title="Consider marking as ghosted if appropriate" style="margin-left:0.4rem; color:#b45309; font-size:0.9rem;">(Consider ghosted)</span>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
      <div style="display: flex; gap: 2rem; align-items: flex-start;">
        <div style="flex: 1;">
          <form method="post" class="edit-form">
          {% csrf_token %}
          <input type="hidden" name="company" value="{{ selected_company.id }}" />
          <label for="id_name">Company Name</label>
          {{ form.name }}
          <label for="id_domain">Domain Name</label>
          {{ form.domain }}
          <label for="id_ats">ATS Domain (if any)</label>
          {{ form.ats }}
          <label for="id_homepage">Homepage</label>
          {{ form.homepage }}
          <label for="id_contact_name">Contact Name</label>
          {{ form.contact_name }}
          <label for="id_contact_email">Contact Email</label>
          {{ form.contact_email }}
          <label for="id_status">Status</label>
          {{ form.status }}
          <button type="submit" style="background:#2563eb; color:white; font-weight:600; border-radius:6px; padding:0.6rem 1.2rem; border:none; cursor:pointer; margin-top:1rem;">Save Changes</button>
        </form>
        </div>
        <div style="flex: 1; background: #f3f4f6; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
          <h2 style="margin-top:0; color:#1e40af; font-size:1.1rem;">Company Data Preview</h2>
          <div style="margin-bottom:1rem;"><strong>Messages in database:</strong> {{ message_count }}</div>
          <div style="max-height: 320px; overflow-y: auto;">
            <strong>All Email Dates &amp; Subjects to be Deleted:</strong>
            <ul style="margin:0.5rem 0 0 0; padding-left:1.2rem; font-size:0.97rem;">
              {% for ts, subj in message_info_list %}
                <li><span style="color:#6b7280;">{{ ts|date:"Y-m-d H:i" }}</span> â€” <span style="color:#111827;">{{ subj|truncatechars:80 }}</span></li>
              {% empty %}
                <li style="color:#9ca3af;">No messages found for this company.</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      {% else %}
        <div style="color:#9ca3af; margin-top:2rem;">Select a company to edit its details.</div>
      {% endif %}
    </div>
{% endblock %}
