{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2>Domain Configuration</h2>
            <p class="text-muted">
                Classify email domains to improve message classification accuracy. 
                Domains are automatically extracted from ingested messages.
            </p>
        </div>
    </div>

    {% if message %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}



    <div class="row mb-3">
        <div class="col-md-6">
            <form method="get" class="d-flex gap-2">
                <input type="hidden" name="filter" value="{{ current_filter }}">
                <input type="hidden" name="sort" value="{{ sort_by }}">
                <input type="hidden" name="order" value="{{ sort_order }}">
                <input type="search" name="search" class="form-control" 
                       placeholder="Search domains..." value="{{ search_query }}">
                <button type="submit" class="btn btn-primary">üîç Search</button>
                {% if search_query %}
                    <a href="?filter={{ current_filter }}&sort={{ sort_by }}&order={{ sort_order }}" 
                       class="btn btn-outline-secondary">Clear</a>
                {% endif %}
            </form>
        </div>
        <div class="col-md-6 text-end">
            <small class="text-muted">
                Showing {{ domains|length }} domain(s)
                {% if search_query %}matching "{{ search_query }}"{% endif %}
            </small>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="?filter=unlabeled{% if search_query %}&search={{ search_query }}{% endif %}&sort={{ sort_by }}&order={{ sort_order }}" 
                   class="btn btn-outline-primary {% if current_filter == 'unlabeled' %}active{% endif %}">
                    Unlabeled ({{ stats.unlabeled }})
                </a>
                <a href="?filter=personal{% if search_query %}&search={{ search_query }}{% endif %}&sort={{ sort_by }}&order={{ sort_order }}" 
                   class="btn btn-outline-secondary {% if current_filter == 'personal' %}active{% endif %}">
                    Personal ({{ stats.personal }})
                </a>
                <a href="?filter=company{% if search_query %}&search={{ search_query }}{% endif %}&sort={{ sort_by }}&order={{ sort_order }}" 
                   class="btn btn-outline-info {% if current_filter == 'company' %}active{% endif %}">
                    Company ({{ stats.company }})
                </a>
                <a href="?filter=ats{% if search_query %}&search={{ search_query }}{% endif %}&sort={{ sort_by }}&order={{ sort_order }}" 
                   class="btn btn-outline-success {% if current_filter == 'ats' %}active{% endif %}">
                    ATS ({{ stats.ats }})
                </a>
                <a href="?filter=headhunter{% if search_query %}&search={{ search_query }}{% endif %}&sort={{ sort_by }}&order={{ sort_order }}" 
                   class="btn btn-outline-warning {% if current_filter == 'headhunter' %}active{% endif %}">
                    Headhunter ({{ stats.headhunter }})
                </a>
                <a href="?filter=job_boards{% if search_query %}&search={{ search_query }}{% endif %}&sort={{ sort_by }}&order={{ sort_order }}" 
                   class="btn btn-outline-danger {% if current_filter == 'job_boards' %}active{% endif %}">
                    Job Boards ({{ stats.job_boards }})
                </a>
                <a href="?filter=all{% if search_query %}&search={{ search_query }}{% endif %}&sort={{ sort_by }}&order={{ sort_order }}" 
                   class="btn btn-outline-dark {% if current_filter == 'all' %}active{% endif %}">
                    All ({{ stats.total }})
                </a>
            </div>
        </div>
    </div>

    <form method="post" action="{% url 'manage_domains' %}">
        {% csrf_token %}
        <input type="hidden" name="current_filter" value="{{ current_filter }}">
        <input type="hidden" name="search_query" value="{{ search_query }}">
        
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title">üîÑ Re-ingest Messages</h5>
                        <p class="card-text mb-2">
                            After labeling domains, re-ingest messages to apply the new classifications.
                        </p>
                        <div class="row align-items-end">
                            <div class="col-md-4">
                                <label for="reingest_filter" class="form-label">Re-ingest messages from:</label>
                                <select name="reingest_filter" id="reingest_filter" class="form-select">
                                    <option value="current_filter">Current filter ({{ domains|length }} domain(s))</option>
                                    <option value="personal">Personal domains only</option>
                                    <option value="selected">Selected domains below</option>
                                    <option value="all_labeled">All labeled domains</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" name="action" value="reingest_domains" class="btn btn-warning">
                                    üîÑ Re-ingest Messages
                                </button>
                            </div>
                            <div class="col-md-5">
                                <small class="text-muted">
                                    <strong>Note:</strong> May take several minutes for large datasets.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-info bg-opacity-10 border-info">
                    <div class="card-body">
                        <h5 class="card-title">üì• Sync Database to JSON</h5>
                        <p class="card-text mb-2">
                            Sync company domains from the database to companies.json. This adds domains from the Label Companies page to the configuration file.
                        </p>
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <button type="submit" name="action" value="sync_db_to_json" class="btn btn-info">
                                    üì• Sync Domains to companies.json
                                </button>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>Note:</strong> Only syncs domains labeled as Company or Headhunter. Personal/receipt domains are skipped.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <button type="submit" name="action" value="bulk_label" data-label-type="personal" class="btn btn-secondary label-btn">
                    Mark Selected as Personal
                </button>
                <button type="submit" name="action" value="bulk_label" data-label-type="company" class="btn btn-info label-btn">
                    Mark Selected as Company
                </button>
                <button type="submit" name="action" value="bulk_label" data-label-type="ats" class="btn btn-success label-btn">
                    Mark Selected as ATS
                </button>
                <button type="submit" name="action" value="bulk_label" data-label-type="headhunter" class="btn btn-warning label-btn">
                    Mark Selected as Headhunter
                </button>
                <button type="submit" name="action" value="bulk_label" data-label-type="job_boards" class="btn btn-danger label-btn">
                    Mark Selected as Job Board
                </button>
                <span class="mx-2">|</span>
                <button type="button" id="select-all" class="btn btn-outline-secondary">
                    Select All
                </button>
                <button type="button" id="deselect-all" class="btn btn-outline-secondary">
                    Deselect All
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" id="select-all-checkbox">
                        </th>
                        <th>
                            <a href="?filter={{ current_filter }}{% if search_query %}&search={{ search_query }}{% endif %}&sort=domain&order={% if sort_by == 'domain' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                               class="text-decoration-none text-dark">
                                Domain 
                                {% if sort_by == 'domain' %}
                                    {% if sort_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="?filter={{ current_filter }}{% if search_query %}&search={{ search_query }}{% endif %}&sort=count&order={% if sort_by == 'count' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                               class="text-decoration-none text-dark">
                                Message Count 
                                {% if sort_by == 'count' %}
                                    {% if sort_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="?filter={{ current_filter }}{% if search_query %}&search={{ search_query }}{% endif %}&sort=label&order={% if sort_by == 'label' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                               class="text-decoration-none text-dark">
                                Current Label 
                                {% if sort_by == 'label' %}
                                    {% if sort_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th>Sample Senders</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for domain_info in domains %}
                    <tr>
                        <td>
                            <input type="checkbox" name="domains" value="{{ domain_info.domain }}" 
                                   class="domain-checkbox">
                        </td>
                        <td>
                            <strong>{{ domain_info.domain }}</strong>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ domain_info.count }}</span>
                        </td>
                        <td>
                            {% if domain_info.label == 'personal' %}
                                <span class="badge bg-secondary">Personal</span>
                            {% elif domain_info.label == 'company' %}
                                <span class="badge bg-info">Company</span>
                            {% elif domain_info.label == 'ats' %}
                                <span class="badge bg-success">ATS</span>
                            {% elif domain_info.label == 'headhunter' %}
                                <span class="badge bg-warning">Headhunter</span>
                            {% elif domain_info.label == 'job_boards' %}
                                <span class="badge bg-danger">Job Board</span>
                            {% else %}
                                <span class="badge bg-light text-dark">Unlabeled</span>
                            {% endif %}
                            {% if domain_info.company_name %}
                                <br><small class="text-muted">‚Üí {{ domain_info.company_name }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">
                                {% for sender in domain_info.sample_senders %}
                                    {{ sender }}<br>
                                {% endfor %}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-sm btn-outline-secondary quick-label" 
                                        data-domain="{{ domain_info.domain }}" data-label="personal" title="Personal">P</button>
                                <button type="button" class="btn btn-sm btn-outline-info quick-label" 
                                        data-domain="{{ domain_info.domain }}" data-label="company" title="Company">C</button>
                                <button type="button" class="btn btn-sm btn-outline-success quick-label" 
                                        data-domain="{{ domain_info.domain }}" data-label="ats" title="ATS">A</button>
                                <button type="button" class="btn btn-sm btn-outline-warning quick-label" 
                                        data-domain="{{ domain_info.domain }}" data-label="headhunter" title="Headhunter">H</button>
                                <button type="button" class="btn btn-sm btn-outline-danger quick-label" 
                                        data-domain="{{ domain_info.domain }}" data-label="job_boards" title="Job Board">J</button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            No domains found for this filter.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Domain Classification Guide</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-2">Personal</dt>
                        <dd class="col-sm-10">
                            Personal email domains (gmail.com, yahoo.com, family domains, etc.). 
                            User replies to these domains will be automatically classified as "noise".
                        </dd>

                        <dt class="col-sm-2">Company</dt>
                        <dd class="col-sm-10">
                            Corporate email domains that map to specific companies (e.g., microsoft.com ‚Üí Microsoft).
                            Used for company resolution during message ingestion.
                        </dd>

                        <dt class="col-sm-2">ATS</dt>
                        <dd class="col-sm-10">
                            Applicant Tracking System domains (greenhouse.io, lever.co, workday.com, etc.).
                            Messages from these domains may have special parsing rules.
                        </dd>

                        <dt class="col-sm-2">Headhunter</dt>
                        <dd class="col-sm-10">
                            Recruiting agency domains. Messages from these domains are typically classified as "head_hunter".
                        </dd>

                        <dt class="col-sm-2">Job Boards</dt>
                        <dd class="col-sm-10">
                            Job board and career site domains (indeed.com, linkedin.com, glassdoor.com, etc.).
                            Messages from these domains are typically automated notifications about job postings.
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    {% if reingest_summary %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5>‚úÖ Re-ingestion Complete</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-3">Domains Processed:</dt>
                        <dd class="col-sm-9">{{ reingest_summary.domains_processed }}</dd>
                        
                        <dt class="col-sm-3">Messages Re-ingested:</dt>
                        <dd class="col-sm-9">{{ reingest_summary.messages_processed }}</dd>
                        
                        <dt class="col-sm-3">Updated to Noise:</dt>
                        <dd class="col-sm-9">{{ reingest_summary.updated_to_noise }}</dd>
                        
                        <dt class="col-sm-3">Kept as Other:</dt>
                        <dd class="col-sm-9">{{ reingest_summary.kept_as_other }}</dd>
                        
                        <dt class="col-sm-3">Errors:</dt>
                        <dd class="col-sm-9">{{ reingest_summary.errors }}</dd>
                        
                        {% if reingest_summary.sample_updates %}
                        <dt class="col-sm-3">Sample Updates:</dt>
                        <dd class="col-sm-9">
                            <ul class="list-unstyled mb-0">
                                {% for sample in reingest_summary.sample_updates %}
                                <li><small>{{ sample }}</small></li>
                                {% endfor %}
                            </ul>
                        </dd>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Hidden form for quick single-domain labeling -->
<form id="quick-label-form" method="post" action="{% url 'manage_domains' %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="action" value="label_single">
    <input type="hidden" name="domain" id="quick-domain">
    <input type="hidden" name="label_type" id="quick-label-type">
</form>

<script>
document.getElementById('select-all-checkbox').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.domain-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

document.getElementById('select-all').addEventListener('click', function() {
    document.querySelectorAll('.domain-checkbox').forEach(cb => cb.checked = true);
});

document.getElementById('deselect-all').addEventListener('click', function() {
    document.querySelectorAll('.domain-checkbox').forEach(cb => cb.checked = false);
});

// Handle quick label buttons (P, C, A, H, J)
document.querySelectorAll('.quick-label').forEach(button => {
    button.addEventListener('click', function() {
        const domain = this.dataset.domain;
        const labelType = this.dataset.label;
        
        document.getElementById('quick-domain').value = domain;
        document.getElementById('quick-label-type').value = labelType;
        document.getElementById('quick-label-form').submit();
    });
});

// Handle bulk label buttons - add label_type as hidden input when clicked
document.querySelectorAll('.label-btn').forEach(button => {
    button.addEventListener('click', function(e) {
        const labelType = this.dataset.labelType;
        
        // Remove any existing label_type input
        const existingInput = document.querySelector('input[name="label_type"]');
        if (existingInput) {
            existingInput.remove();
        }
        
        // Add new label_type input
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'label_type';
        input.value = labelType;
        this.form.appendChild(input);
    });
});
</script>
{% endblock %}
