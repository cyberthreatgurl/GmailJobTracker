{% extends "base.html" %}
{% block title %}Manual Entry - GmailJobTracker{% endblock %}
{% block extra_head %}
  <style>
    .manual-entry-container {
      max-width: 900px;
      margin: 0 auto;
    }
    .form-card {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .form-card h2 {
      margin-top: 0;
      color: #1f2937;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.95rem;
      font-family: inherit;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .help-text {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 0.3rem;
    }
    .submit-btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .submit-btn:hover {
      background: #1e40af;
    }
    .recent-entries {
      background: #f9fafb;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .recent-entries h3 {
      margin-top: 0;
      color: #1f2937;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    .entry-item {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 0.75rem;
      border-left: 4px solid #2563eb;
    }
    .entry-item.interview {
      border-left-color: #22c55e;
    }
    .entry-item.rejection {
      border-left-color: #ef4444;
    }
    .entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .entry-title {
      font-weight: 600;
      color: #111827;
      font-size: 0.95rem;
    }
    .entry-date {
      color: #6b7280;
      font-size: 0.85rem;
    }
    .entry-company {
      color: #2563eb;
      font-size: 0.9rem;
    }
    .entry-actions {
      margin-top: 0.75rem;
      display: flex;
      gap: 0.5rem;
    }
    .entry-btn {
      padding: 0.35rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .edit-btn {
      background: #dbeafe;
      color: #1e40af;
    }
    .edit-btn:hover {
      background: #bfdbfe;
    }
    .delete-btn {
      background: #fee2e2;
      color: #991b1b;
    }
    .delete-btn:hover {
      background: #fecaca;
    }
    .entry-checkbox {
      margin-right: 0.5rem;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }
    .bulk-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: white;
      border-radius: 6px;
    }
    .bulk-delete-btn {
      padding: 0.5rem 1rem;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .bulk-delete-btn:hover {
      background: #dc2626;
    }
    .bulk-delete-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
    }
    .select-all-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #374151;
    }
    .entry-type-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .entry-type-badge.application {
      background: #dbeafe;
      color: #1e40af;
    }
    .entry-type-badge.interview {
      background: #d1fae5;
      color: #065f46;
    }
    .entry-type-badge.rejection {
      background: #fee2e2;
      color: #991b1b;
    }
    .error {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    .errorlist {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0 0 0;
    }
    .errorlist li {
      color: #dc2626;
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }
  </style>
{% endblock %}

{% block content %}
<div class="manual-entry-container">
  <h1>üìù Manual Entry</h1>
  <p style="color: #6b7280; margin-bottom: 1rem;">
    Add job applications from external sources (LinkedIn, Indeed, email, etc.)
  </p>
  <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 2rem;">
    üí° <strong>Tip:</strong> To update milestone dates (prescreen, interview, rejection, offer), use the 
    <a href="{% url 'label_companies' %}" style="color: #2563eb;">Label Companies</a> page ‚Üí Application Details section.
  </p>

  {% if messages %}
    {% for message in messages %}
      <div class="{% if message.tags %}{{ message.tags }}{% endif %}" style="background: #d1fae5; border: 1px solid #a7f3d0; color: #065f46; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <div class="form-card">
    <h2>{% if is_edit %}Edit Application{% else %}Add New Application{% endif %}</h2>
    <form method="post">
      {% csrf_token %}

      <div class="form-group">
        <label for="{{ form.company_select.id_for_label }}">{{ form.company_select.label }}</label>
        {{ form.company_select }}
        <div class="help-text">{{ form.company_select.help_text }}</div>
        {% if form.company_select.errors %}
          <ul class="errorlist">
            {% for error in form.company_select.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="form-group" id="new-company-name-group" style="display: none;">
        <label for="{{ form.new_company_name.id_for_label }}">{{ form.new_company_name.label }}</label>
        {{ form.new_company_name }}
        <div class="help-text">{{ form.new_company_name.help_text }}</div>
        {% if form.new_company_name.errors %}
          <ul class="errorlist">
            {% for error in form.new_company_name.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="{{ form.job_title.id_for_label }}">{{ form.job_title.label }}</label>
          {{ form.job_title }}
          <div class="help-text">{{ form.job_title.help_text }}</div>
          {% if form.job_title.errors %}
            <ul class="errorlist">
              {% for error in form.job_title.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.job_id.id_for_label }}">{{ form.job_id.label }}</label>
          {{ form.job_id }}
          <div class="help-text">{{ form.job_id.help_text }}</div>
          {% if form.job_id.errors %}
            <ul class="errorlist">
              {% for error in form.job_id.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="{{ form.application_date.id_for_label }}">{{ form.application_date.label }}</label>
          {{ form.application_date }}
          <div class="help-text">{{ form.application_date.help_text }}</div>
          {% if form.application_date.errors %}
            <ul class="errorlist">
              {% for error in form.application_date.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.source.id_for_label }}">{{ form.source.label }}</label>
          {{ form.source }}
          <div class="help-text">{{ form.source.help_text }}</div>
          {% if form.source.errors %}
            <ul class="errorlist">
              {% for error in form.source.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="{{ form.application_url.id_for_label }}">{{ form.application_url.label }}</label>
        {{ form.application_url }}
        <div class="help-text">{{ form.application_url.help_text }}</div>
        {% if form.application_url.errors %}
          <ul class="errorlist">
            {% for error in form.application_url.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
        {{ form.notes }}
        <div class="help-text">{{ form.notes.help_text }}</div>
        {% if form.notes.errors %}
          <ul class="errorlist">
            {% for error in form.notes.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <button type="submit" class="submit-btn">{% if is_edit %}Update Application{% else %}Add Application{% endif %}</button>
      {% if is_edit %}
        <a href="{% url 'manual_entry' %}" class="submit-btn" style="background: #6b7280; margin-left: 1rem; display: inline-block; text-decoration: none;">Cancel</a>
      {% endif %}
    </form>
  </div>

  <script>
    // Show/hide new company name field based on dropdown selection
    const companySelect = document.getElementById('{{ form.company_select.id_for_label }}');
    const newCompanyNameGroup = document.getElementById('new-company-name-group');
    const newCompanyNameInput = document.getElementById('{{ form.new_company_name.id_for_label }}');

    function toggleNewCompanyField() {
      const isNewCompany = companySelect.value === '__new__';
      if (isNewCompany) {
        newCompanyNameGroup.style.display = 'block';
        newCompanyNameInput.required = true;
      } else {
        newCompanyNameGroup.style.display = 'none';
        newCompanyNameInput.required = false;
        newCompanyNameInput.value = '';  // Clear the field when hidden
      }
    }

    // Initialize on page load
    toggleNewCompanyField();

    // Update when dropdown changes
    companySelect.addEventListener('change', toggleNewCompanyField);
  </script>

  <script>
    // Bulk delete functionality
    const selectAllCheckbox = document.getElementById('select-all');
    const entryCheckboxes = document.querySelectorAll('.entry-select');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const selectedCountSpan = document.getElementById('selected-count');

    function updateBulkDeleteButton() {
      const checkedCount = document.querySelectorAll('.entry-select:checked').length;
      selectedCountSpan.textContent = checkedCount;
      bulkDeleteBtn.disabled = checkedCount === 0;
    }

    // Select all functionality
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        entryCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        updateBulkDeleteButton();
      });
    }

    // Individual checkbox changes
    entryCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        // Update select all checkbox state
        const allChecked = Array.from(entryCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(entryCheckboxes).some(cb => cb.checked);
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
        updateBulkDeleteButton();
      });
    });

    // Initialize button state
    updateBulkDeleteButton();
  </script>

  {% if recent_entries %}
  <div class="recent-entries">
    <h3>Recent Manual Entries ({{ recent_entries|length }})</h3>
    
    <form id="bulk-delete-form" method="post" action="{% url 'bulk_delete_manual_entries' %}">
      {% csrf_token %}
      
      <div class="bulk-actions" style="margin-bottom: 1rem;">
        <div class="select-all-container" style="display: inline-flex; align-items: center; gap: 0.5rem;">
          <input type="checkbox" id="select-all" class="entry-checkbox">
          <label for="select-all" style="cursor: pointer; margin: 0;">Select All</label>
        </div>
        <button type="submit" id="bulk-delete-btn" class="bulk-delete-btn" disabled onclick="return confirm('Are you sure you want to delete the selected entries?')">üóëÔ∏è Delete Selected (<span id="selected-count">0</span>)</button>
      </div>
      
      <table id="manual-entries-table" style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
        <thead>
          <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
            <th style="padding: 0.75rem 0.5rem; text-align: left; width: 30px;"></th>
            <th class="sortable" data-sort="event" style="padding: 0.75rem 0.5rem; text-align: left; cursor: pointer; white-space: nowrap;">Job Event <span class="sort-indicator">‚áÖ</span></th>
            <th class="sortable" data-sort="title" style="padding: 0.75rem 0.5rem; text-align: left; cursor: pointer;">Title <span class="sort-indicator">‚áÖ</span></th>
            <th class="sortable" data-sort="company" style="padding: 0.75rem 0.5rem; text-align: left; cursor: pointer;">Company <span class="sort-indicator">‚áÖ</span></th>
            <th class="sortable" data-sort="event-date" style="padding: 0.75rem 0.5rem; text-align: left; cursor: pointer; white-space: nowrap;">Date of Event <span class="sort-indicator">‚áÖ</span></th>
            <th class="sortable" data-sort="creation-date" style="padding: 0.75rem 0.5rem; text-align: left; cursor: pointer; white-space: nowrap;">Creation Date <span class="sort-indicator">‚áÖ</span></th>
            <th style="padding: 0.75rem 0.5rem; text-align: center;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in recent_entries %}
          <tr class="entry-row" style="border-bottom: 1px solid #e5e7eb;"
              data-event="{% if entry.status == 'offer' %}offer{% elif entry.status == 'rejected' %}rejection{% elif entry.status == 'interview' %}interview{% elif entry.status == 'prescreen' %}prescreen{% else %}{{ entry.ml_label }}{% endif %}"
              data-title="{{ entry.job_title|lower }}"
              data-company="{{ entry.company.name|lower }}"
              data-event-date="{% if entry.status == 'offer' and entry.offer_date %}{{ entry.offer_date|date:'Y-m-d' }}{% elif entry.status == 'rejected' and entry.rejection_date %}{{ entry.rejection_date|date:'Y-m-d' }}{% elif entry.status == 'interview' and entry.interview_date %}{{ entry.interview_date|date:'Y-m-d' }}{% elif entry.status == 'prescreen' and entry.prescreen_date %}{{ entry.prescreen_date|date:'Y-m-d' }}{% else %}{{ entry.sent_date|date:'Y-m-d' }}{% endif %}"
              data-creation-date="{% if entry.updated_at %}{{ entry.updated_at|date:'Y-m-d' }}{% else %}{{ entry.sent_date|date:'Y-m-d' }}{% endif %}">
            <td style="padding: 0.5rem;">
              <input type="checkbox" name="thread_ids" value="{{ entry.thread_id }}" class="entry-checkbox entry-select">
            </td>
            <td style="padding: 0.5rem;">
              {% if entry.status == "offer" %}
                <span style="background: #d1fae5; color: #065f46; border-radius: 3px; padding: 0.15rem 0.4rem; font-size: 0.8rem; font-weight: 600;">üéâ Offer</span>
              {% elif entry.status == "rejected" %}
                <span style="background: #fee2e2; color: #991b1b; border-radius: 3px; padding: 0.15rem 0.4rem; font-size: 0.8rem; font-weight: 600;">Rejection</span>
              {% elif entry.status == "interview" %}
                <span style="background: #dbeafe; color: #1e40af; border-radius: 3px; padding: 0.15rem 0.4rem; font-size: 0.8rem; font-weight: 600;">Interview</span>
              {% elif entry.status == "prescreen" %}
                <span style="background: #fef3c7; color: #92400e; border-radius: 3px; padding: 0.15rem 0.4rem; font-size: 0.8rem; font-weight: 600;">Prescreen</span>
              {% else %}
                <span style="background: #dcfce7; color: #166534; border-radius: 3px; padding: 0.15rem 0.4rem; font-size: 0.8rem; font-weight: 600;">Application</span>
              {% endif %}
            </td>
            <td style="padding: 0.5rem;">{{ entry.job_title|default:"(No title)" }}</td>
            <td style="padding: 0.5rem;">
              <a href="{% url 'label_companies' %}?company={{ entry.company.id }}" style="text-decoration: none; color: #2563eb;">
                {{ entry.company.name }}
              </a>
            </td>
            <td style="padding: 0.5rem; white-space: nowrap;">
              {% if entry.status == "offer" and entry.offer_date %}
                {{ entry.offer_date|date:"M d, Y" }}
              {% elif entry.status == "rejected" and entry.rejection_date %}
                {{ entry.rejection_date|date:"M d, Y" }}
              {% elif entry.status == "interview" and entry.interview_date %}
                {{ entry.interview_date|date:"M d, Y" }}
              {% elif entry.status == "prescreen" and entry.prescreen_date %}
                {{ entry.prescreen_date|date:"M d, Y" }}
              {% else %}
                {{ entry.sent_date|date:"M d, Y" }}
              {% endif %}
            </td>
            <td style="padding: 0.5rem; white-space: nowrap;">{% if entry.updated_at %}{{ entry.updated_at|date:"M d, Y" }}{% else %}{{ entry.sent_date|date:"M d, Y" }}{% endif %}</td>
            <td style="padding: 0.5rem; text-align: center; white-space: nowrap;">
              <a href="{% url 'edit_manual_entry' entry.thread_id %}" class="entry-btn edit-btn" style="margin-right: 0.25rem;">‚úèÔ∏è Edit</a>
              <button type="button" class="entry-btn delete-btn" onclick="if(confirm('Are you sure you want to delete this entry?')) { document.getElementById('delete-form-{{ entry.thread_id }}').submit(); }">üóëÔ∏è Delete</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      
      {% for entry in recent_entries %}
      <form id="delete-form-{{ entry.thread_id }}" method="post" action="{% url 'delete_manual_entry' entry.thread_id %}" style="display: none;">
        {% csrf_token %}
      </form>
      {% endfor %}
    </form>
  </div>
  
  <script>
    // Table sorting functionality
    (function() {
      const table = document.getElementById('manual-entries-table');
      if (!table) return;
      
      const headers = table.querySelectorAll('th.sortable');
      let currentSort = { column: null, ascending: true };
      
      headers.forEach(header => {
        header.addEventListener('click', function() {
          const sortKey = this.dataset.sort;
          const ascending = currentSort.column === sortKey ? !currentSort.ascending : true;
          currentSort = { column: sortKey, ascending };
          
          // Update sort indicators
          headers.forEach(h => {
            const indicator = h.querySelector('.sort-indicator');
            if (indicator) indicator.textContent = '‚áÖ';
          });
          const indicator = this.querySelector('.sort-indicator');
          if (indicator) indicator.textContent = ascending ? '‚Üë' : '‚Üì';
          
          // Sort rows
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr.entry-row'));
          
          rows.sort((a, b) => {
            let aVal = a.dataset[sortKey.replace('-', '')] || a.dataset[sortKey.replace(/-/g, '')] || '';
            let bVal = b.dataset[sortKey.replace('-', '')] || b.dataset[sortKey.replace(/-/g, '')] || '';
            
            // Handle date sorting
            if (sortKey.includes('date')) {
              aVal = aVal || '0000-00-00';
              bVal = bVal || '0000-00-00';
            }
            
            if (aVal < bVal) return ascending ? -1 : 1;
            if (aVal > bVal) return ascending ? 1 : -1;
            return 0;
          });
          
          rows.forEach(row => tbody.appendChild(row));
        });
      });
    })();
  </script>
  {% endif %}
</div>
{% endblock %}
