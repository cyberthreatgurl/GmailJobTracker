{% extends "base.html" %}
{% block title %}Manual Entry - GmailJobTracker{% endblock %}
{% block extra_head %}
  <style>
    .manual-entry-container {
      max-width: 900px;
      margin: 0 auto;
    }
    .form-card {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .form-card h2 {
      margin-top: 0;
      color: #1f2937;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.95rem;
      font-family: inherit;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .help-text {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 0.3rem;
    }
    .radio-group {
      display: flex;
      gap: 1.5rem;
      margin-top: 0.5rem;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      cursor: pointer;
    }
    .radio-group input[type="radio"] {
      width: auto;
      cursor: pointer;
    }
    .submit-btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .submit-btn:hover {
      background: #1e40af;
    }
    .recent-entries {
      background: #f9fafb;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .recent-entries h3 {
      margin-top: 0;
      color: #1f2937;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    .entry-item {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 0.75rem;
      border-left: 4px solid #2563eb;
    }
    .entry-item.interview {
      border-left-color: #22c55e;
    }
    .entry-item.rejection {
      border-left-color: #ef4444;
    }
    .entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .entry-title {
      font-weight: 600;
      color: #111827;
      font-size: 0.95rem;
    }
    .entry-date {
      color: #6b7280;
      font-size: 0.85rem;
    }
    .entry-company {
      color: #2563eb;
      font-size: 0.9rem;
    }
    .entry-actions {
      margin-top: 0.75rem;
      display: flex;
      gap: 0.5rem;
    }
    .entry-btn {
      padding: 0.35rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .edit-btn {
      background: #dbeafe;
      color: #1e40af;
    }
    .edit-btn:hover {
      background: #bfdbfe;
    }
    .delete-btn {
      background: #fee2e2;
      color: #991b1b;
    }
    .delete-btn:hover {
      background: #fecaca;
    }
    .entry-checkbox {
      margin-right: 0.5rem;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }
    .bulk-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: white;
      border-radius: 6px;
    }
    .bulk-delete-btn {
      padding: 0.5rem 1rem;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .bulk-delete-btn:hover {
      background: #dc2626;
    }
    .bulk-delete-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
    }
    .select-all-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #374151;
    }
    .entry-type-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .entry-type-badge.application {
      background: #dbeafe;
      color: #1e40af;
    }
    .entry-type-badge.interview {
      background: #d1fae5;
      color: #065f46;
    }
    .entry-type-badge.rejection {
      background: #fee2e2;
      color: #991b1b;
    }
    .error {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    .errorlist {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0 0 0;
    }
    .errorlist li {
      color: #dc2626;
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }
  </style>
{% endblock %}

{% block content %}
<div class="manual-entry-container">
  <h1>üìù Manual Entry</h1>
  <p style="color: #6b7280; margin-bottom: 2rem;">
    Add job applications, interviews, or rejections from external sources (LinkedIn, Indeed, email, etc.)
  </p>

  {% if messages %}
    {% for message in messages %}
      <div class="{% if message.tags %}{{ message.tags }}{% endif %}" style="background: #d1fae5; border: 1px solid #a7f3d0; color: #065f46; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <div class="form-card">
    <h2>{% if is_edit %}Edit Entry{% else %}Add New Entry{% endif %}</h2>
    <form method="post">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="{{ form.entry_type.id_for_label }}">{{ form.entry_type.label }}</label>
        <div class="radio-group">
          {% for choice in form.entry_type %}
            {{ choice }}
          {% endfor %}
        </div>
        {% if form.entry_type.errors %}
          <ul class="errorlist">
            {% for error in form.entry_type.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ form.company_select.id_for_label }}">{{ form.company_select.label }}</label>
        {{ form.company_select }}
        <div class="help-text">{{ form.company_select.help_text }}</div>
        <div id="new-company-warning" style="display: none; background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
          ‚ö†Ô∏è <strong>Please create a Job Application first.</strong> You cannot add a prescreen, interview, or rejection for a new company without an existing application.
        </div>
        {% if form.company_select.errors %}
          <ul class="errorlist">
            {% for error in form.company_select.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="form-group" id="new-company-name-group" style="display: none;">
        <label for="{{ form.new_company_name.id_for_label }}">{{ form.new_company_name.label }}</label>
        {{ form.new_company_name }}
        <div class="help-text">{{ form.new_company_name.help_text }}</div>
        {% if form.new_company_name.errors %}
          <ul class="errorlist">
            {% for error in form.new_company_name.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group" id="job-title-group">
          <label for="{{ form.job_title.id_for_label }}">{{ form.job_title.label }}</label>
          <!-- Job title dropdown for prescreen/interview/rejection -->
          <div id="job-title-select-container" style="display: none; margin-bottom: 0.5rem;">
            <select id="job-title-select" style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; margin-bottom: 0.5rem;">
              <option value="">-- Select existing job title --</option>
            </select>
            <div id="no-applications-warning" style="display: none; background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 0.5rem; border-radius: 4px; font-size: 0.85rem; margin-bottom: 0.5rem;">
              ‚ö†Ô∏è No existing applications found for this company. Please add a Job Application first, or enter a new job title below.
            </div>
          </div>
          {{ form.job_title }}
          <div class="help-text" id="job-title-help">{{ form.job_title.help_text }}</div>
          {% if form.job_title.errors %}
            <ul class="errorlist">
              {% for error in form.job_title.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.job_id.id_for_label }}">{{ form.job_id.label }}</label>
          {{ form.job_id }}
          <div class="help-text">{{ form.job_id.help_text }}</div>
          {% if form.job_id.errors %}
            <ul class="errorlist">
              {% for error in form.job_id.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
        <div class="form-group">
          <label for="{{ form.application_date.id_for_label }}">{{ form.application_date.label }}</label>
          {{ form.application_date }}
          <div class="help-text">{{ form.application_date.help_text }}</div>
          {% if form.application_date.errors %}
            <ul class="errorlist">
              {% for error in form.application_date.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.interview_date.id_for_label }}">{{ form.interview_date.label }}</label>
          {{ form.interview_date }}
          <div class="help-text">{{ form.interview_date.help_text }}</div>
          {% if form.interview_date.errors %}
            <ul class="errorlist">
              {% for error in form.interview_date.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.source.id_for_label }}">{{ form.source.label }}</label>
          {{ form.source }}
          <div class="help-text">{{ form.source.help_text }}</div>
          {% if form.source.errors %}
            <ul class="errorlist">
              {% for error in form.source.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
        {{ form.notes }}
        <div class="help-text">{{ form.notes.help_text }}</div>
        {% if form.notes.errors %}
          <ul class="errorlist">
            {% for error in form.notes.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <button type="submit" class="submit-btn">{% if is_edit %}Update Entry{% else %}Add Entry{% endif %}</button>
      {% if is_edit %}
        <a href="{% url 'manual_entry' %}" class="submit-btn" style="background: #6b7280; margin-left: 1rem; display: inline-block; text-decoration: none;">Cancel</a>
      {% endif %}
    </form>
  </div>

  <script>
    // Show/hide new company name field based on dropdown selection
    const companySelect = document.getElementById('{{ form.company_select.id_for_label }}');
    const newCompanyNameGroup = document.getElementById('new-company-name-group');
    const newCompanyNameInput = document.getElementById('{{ form.new_company_name.id_for_label }}');
    const newCompanyWarning = document.getElementById('new-company-warning');
    const submitBtn = document.querySelector('.submit-btn');
    
    // Job title elements
    const jobTitleInput = document.getElementById('{{ form.job_title.id_for_label }}');
    const jobTitleSelectContainer = document.getElementById('job-title-select-container');
    const jobTitleSelect = document.getElementById('job-title-select');
    const noApplicationsWarning = document.getElementById('no-applications-warning');
    const jobTitleHelp = document.getElementById('job-title-help');
    
    // Cache for job titles per company
    const jobTitlesCache = {};

    function toggleNewCompanyField() {
      const entryType = getSelectedEntryType();
      const isNewCompany = companySelect.value === '__new__';
      const isNonApplicationType = ['prescreen', 'interview', 'rejection'].includes(entryType);
      
      if (isNewCompany) {
        if (isNonApplicationType) {
          // Show warning briefly, then auto-select Job Application
          newCompanyWarning.style.display = 'block';
          newCompanyNameGroup.style.display = 'none';
          
          // Auto-select Job Application after a brief delay so user sees the message
          setTimeout(() => {
            const applicationRadio = document.querySelector('input[name="entry_type"][value="application"]');
            if (applicationRadio) {
              applicationRadio.checked = true;
              // Trigger the change to update the UI
              toggleNewCompanyField();
            }
          }, 1500);  // 1.5 second delay so user can read the message
          
          submitBtn.disabled = true;
          submitBtn.title = 'Switching to Job Application...';
        } else {
          // Normal new company flow for applications
          newCompanyWarning.style.display = 'none';
          newCompanyNameGroup.style.display = 'block';
          newCompanyNameInput.required = true;
          submitBtn.disabled = false;
          submitBtn.title = '';
        }
      } else {
        newCompanyWarning.style.display = 'none';
        newCompanyNameGroup.style.display = 'none';
        newCompanyNameInput.required = false;
        newCompanyNameInput.value = '';  // Clear the field when hidden
        submitBtn.disabled = false;
        submitBtn.title = '';
      }
      // Also update job title dropdown
      updateJobTitleDropdown();
    }
    
    function getSelectedEntryType() {
      const selected = document.querySelector('input[name="entry_type"]:checked');
      return selected ? selected.value : 'application';
    }
    
    async function fetchJobTitles(companyId) {
      if (jobTitlesCache[companyId]) {
        return jobTitlesCache[companyId];
      }
      try {
        const response = await fetch(`/api/company/${companyId}/job_titles/`);
        const data = await response.json();
        if (data.success) {
          jobTitlesCache[companyId] = data.job_titles;
          return data.job_titles;
        }
      } catch (error) {
        console.error('Error fetching job titles:', error);
      }
      return [];
    }
    
    async function updateJobTitleDropdown() {
      const entryType = getSelectedEntryType();
      const companyId = companySelect.value;
      
      // Only show dropdown for prescreen, interview, rejection when a real company is selected
      if (entryType === 'application' || companyId === '__new__' || !companyId) {
        jobTitleSelectContainer.style.display = 'none';
        noApplicationsWarning.style.display = 'none';
        jobTitleHelp.textContent = '{{ form.job_title.help_text }}';
        return;
      }
      
      // Fetch job titles for the selected company
      const jobTitles = await fetchJobTitles(companyId);
      
      // Clear existing options
      jobTitleSelect.innerHTML = '<option value="">-- Select existing job title --</option>';
      
      if (jobTitles.length > 0) {
        // Populate dropdown with job titles
        jobTitles.forEach(title => {
          const option = document.createElement('option');
          option.value = title;
          option.textContent = title;
          jobTitleSelect.appendChild(option);
        });
        
        // Add option for custom entry
        const customOption = document.createElement('option');
        customOption.value = '__custom__';
        customOption.textContent = '-- Enter new job title --';
        jobTitleSelect.appendChild(customOption);
        
        jobTitleSelectContainer.style.display = 'block';
        noApplicationsWarning.style.display = 'none';
        jobTitleHelp.textContent = 'Select from existing applications or enter a new title';
      } else {
        // No applications found - show warning
        jobTitleSelectContainer.style.display = 'block';
        noApplicationsWarning.style.display = 'block';
        jobTitleSelect.style.display = 'none';
        jobTitleHelp.textContent = 'Enter job title manually';
      }
    }
    
    // When job title dropdown changes, update the text input
    jobTitleSelect.addEventListener('change', function() {
      if (this.value === '__custom__' || this.value === '') {
        jobTitleInput.value = '';
        jobTitleInput.focus();
      } else {
        jobTitleInput.value = this.value;
      }
    });
    
    // Listen for entry type changes
    document.querySelectorAll('input[name="entry_type"]').forEach(radio => {
      radio.addEventListener('change', function() {
        toggleNewCompanyField();  // Re-check new company warning
        // Reset job title select visibility
        jobTitleSelect.style.display = 'block';
      });
    });

    // Initialize on page load
    toggleNewCompanyField();

    // Update when dropdown changes
    companySelect.addEventListener('change', function() {
      toggleNewCompanyField();
      // Reset job title select visibility
      jobTitleSelect.style.display = 'block';
    });

    // Bulk delete functionality
    const selectAllCheckbox = document.getElementById('select-all');
    const entryCheckboxes = document.querySelectorAll('.entry-select');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const selectedCountSpan = document.getElementById('selected-count');

    function updateBulkDeleteButton() {
      const checkedCount = document.querySelectorAll('.entry-select:checked').length;
      selectedCountSpan.textContent = checkedCount;
      bulkDeleteBtn.disabled = checkedCount === 0;
    }

    // Select all functionality
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        entryCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        updateBulkDeleteButton();
      });
    }

    // Individual checkbox changes
    entryCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        // Update select all checkbox state
        const allChecked = Array.from(entryCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(entryCheckboxes).some(cb => cb.checked);
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
        updateBulkDeleteButton();
      });
    });

    // Initialize button state
    updateBulkDeleteButton();
  </script>

  {% if recent_entries %}
  <div class="recent-entries">
    <h3>Recent Manual Entries ({{ recent_entries|length }})</h3>
    
    <form id="bulk-delete-form" method="post" action="{% url 'bulk_delete_manual_entries' %}">
      {% csrf_token %}
      
      <div class="bulk-actions">
        <div class="select-all-container">
          <input type="checkbox" id="select-all" class="entry-checkbox">
          <label for="select-all" style="cursor: pointer; margin: 0;">Select All</label>
        </div>
        <button type="submit" id="bulk-delete-btn" class="bulk-delete-btn" disabled onclick="return confirm('Are you sure you want to delete the selected entries?')">üóëÔ∏è Delete Selected (<span id="selected-count">0</span>)</button>
      </div>
      
      {% for entry in recent_entries %}
      <div class="entry-item {{ entry.ml_label }}">
        <div class="entry-header">
          <div style="display: flex; align-items: center;">
            <input type="checkbox" name="thread_ids" value="{{ entry.thread_id }}" class="entry-checkbox entry-select">
            <span class="entry-type-badge {{ entry.ml_label }}">{{ entry.ml_label }}</span>
            <span class="entry-title">{{ entry.job_title }}</span>
          </div>
          <span class="entry-date">{{ entry.sent_date|date:"M d, Y" }}</span>
        </div>
        <div class="entry-company">
          <a href="{% url 'label_companies' %}?company={{ entry.company.id }}" style="text-decoration: none; color: #2563eb;">
            {{ entry.company.name }}
          </a>
        </div>
        <div class="entry-actions">
          <a href="{% url 'edit_manual_entry' entry.thread_id %}" class="entry-btn edit-btn">‚úèÔ∏è Edit</a>
          <form method="post" action="{% url 'delete_manual_entry' entry.thread_id %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="entry-btn delete-btn" onclick="return confirm('Are you sure you want to delete this entry?')">üóëÔ∏è Delete</button>
          </form>
        </div>
    </div>
    {% endfor %}
    </form>
  </div>
  {% endif %}
</div>
{% endblock %}
